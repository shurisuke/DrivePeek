<%# app/views/plans/_start_point_block_edit.html.erb %>
<% plan ||= @plan %>

<%# ✅ 出発地点から最初のスポットまでの区間情報は start_point に保存される %>
<% start_point = plan.start_point %>
<% move_minutes = start_point&.move_time.to_i %>
<% hours = move_minutes / 60 %>
<% minutes = move_minutes % 60 %>

<div class="start-point-block"
     data-controller="start-point-editor"
     data-polyline="<%= plan.start_point&.polyline %>"
     data-lat="<%= plan.start_point&.lat %>"
     data-lng="<%= plan.start_point&.lng %>">
  <% start_detail_open = defined?(@start_point_detail_open) && @start_point_detail_open %>

  <%# ✅ 上部：出発コンテンツ %>
  <div class="start-content">
    <%# 3層構造: アイコン | タイトル | スペーサー %>
    <div class="start-header">
      <span class="start-icon"
            data-controller="navibar-marker-button"
            data-point-type="start"
            data-action="click->navibar-marker-button#point"
            role="button"
            tabindex="0"
            aria-label="出発地点を地図で表示"></span>

      <span class="start-title start-title--clickable"
            data-controller="navibar-marker-button"
            data-point-type="start"
            data-action="click->navibar-marker-button#point"
            role="button"
            tabindex="0">出発</span>

      <div class="start-spacer" aria-hidden="true"></div>
    </div>

    <%# 住所 %>
    <div class="start-address navibar-padding" data-start-point-editor-target="address">
      <%= plan.start_point&.address.presence || "出発地点が未設定です" %>
    </div>

    <%# ✅ スポットが1件以上の場合のみ「次の場所まで」を表示 %>
    <% if plan.plan_spots.exists? %>
      <div class="start-next-move" data-plan-time-role="start-next-move">
        <span class="label">次の場所<span class="label-unit">まで</span></span>
        <span class="separator"></span>
        <span class="km">
          <% if start_point&.move_distance.present? %>
            <%= format_distance(start_point.move_distance) %><span class="km-unit">km</span>
          <% else %>
            —<span class="km-unit">km</span>
          <% end %>
        </span>
        <span class="separator"></span>
        <span class="time">
          <% if start_point&.move_time.present? %>
            <% if hours > 0 %><%= hours %><span class="time-unit">時間</span><% end %><%= minutes %><span class="time-unit">分</span>
          <% else %>
            —
          <% end %>
        </span>
      </div>
    <% end %>
  </div>

  <%# ✅ 下部：トグル詳細コンテンツ %>
  <% if plan.start_point.present? && plan.plan_spots.exists? %>
    <div class="collapse start-detail<%= ' show' if start_detail_open %>" id="startPointDetail-<%= plan.id %>">
      <%# 有料道路設定行 %>
      <div class="start-toll-row">
        <span class="label">有料道路</span>
        <input
          class="option-switch"
          type="checkbox"
          role="switch"
          aria-label="有料道路の使用を切り替える（出発）"
          data-start-point-toll-used-switch="1"
          data-plan-id="<%= plan.id %>"
          <%= 'checked="checked"' if plan.start_point&.toll_used? %>
        >
      </div>

      <%# 出発地点変更フォーム %>
      <div
        id="start-point-edit-<%= plan.id %>"
        class="start-edit"
        hidden
        data-start-point-editor-target="editArea"
      >
        <div class="start-edit__inner">
          <label for="start-point-address-<%= plan.id %>" class="start-edit__label">
            出発地点を変更
          </label>

          <input
            id="start-point-address-<%= plan.id %>"
            type="text"
            class="form-control start-edit__input"
            placeholder="（例: 〇〇市〇〇町〇〇-〇）"
            autocomplete="off"
            data-start-point-editor-target="input"
            data-action="keydown->start-point-editor#search compositionstart->start-point-editor#compositionStart compositionend->start-point-editor#compositionEnd"
          >

          <div class="point-edit__actions">
            <button type="button" class="point-edit__cancel-btn">
              キャンセル
            </button>
            <button type="button" class="point-edit__search-btn">
              検索
            </button>
          </div>
        </div>
      </div>
    </div>

    <%# ✅ トグルボタン %>
    <button
      type="button"
      class="detail-toggle"
      data-bs-toggle="collapse"
      data-bs-target="#startPointDetail-<%= plan.id %>"
      aria-expanded="<%= start_detail_open ? 'true' : 'false' %>"
      aria-controls="startPointDetail-<%= plan.id %>"
    >
      <i class="bi bi-caret-down-fill"></i>
    </button>
  <% end %>
</div>
