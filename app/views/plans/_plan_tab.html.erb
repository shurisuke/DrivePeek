<%# ================================================================
    Planタブ（2カラム構造）
    用途: 出発地点 + プラン内スポット一覧（position順）を描画する
    構造: 左カラム（ブロックコンテンツ）+ 右カラム（時刻レール）
================================================================ %>

<div class="plan-tab-layout" data-controller="plan-tab--time-rail-sync">
  <%# ✅ 左カラム: ブロックコンテンツ %>
  <div class="plan-tab-content">
    <%= render "plans/start_point_block_edit" %>

    <% spot_ids = @plan.plan_spots.pluck(:spot_id) %>
    <% favorite_spots_map = FavoriteSpot.index_by_spot_id(user: current_user, spot_ids: spot_ids) %>

    <%# ✅ SortableJS の「親要素」(この中の .spot-block が入れ替わる) %>
    <div id="plan-spots-sortable" data-sortable="plan-spots">
      <% plan_spots = @plan.plan_spots.includes(spot: :genres).order(:position).to_a %>
      <% plan_spots.each_with_index do |plan_spot, index| %>
        <%= render "plans/spot_block_edit",
                   plan_spot: plan_spot,
                   favorite_spot: favorite_spots_map[plan_spot.spot_id],
                   is_first: index == 0,
                   is_last: index == plan_spots.size - 1 %>
      <% end %>
    </div>

    <%# ✅ 帰宅地点は「スポットの有無」ではなく、トグル操作で表示/非表示を管理する %>
    <%= render "plans/goal_point_block_edit", plan: @plan %>
  </div>

  <%# ✅ 右カラム: 時刻レール（Turbo Frameで遅延読み込み可能） %>
  <div class="plan-tab-time-rail">
    <%= render "plans/time_rail", plan: @plan %>
  </div>
</div>

<%# スポットがない場合はガイド表示 %>
<% if @plan.plan_spots.empty? %>
  <%= render "plans/plan_tab_guide" %>
<% end %>