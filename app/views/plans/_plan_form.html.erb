<% content_for :body_class, "no-footer" %>
<% content_for :hide_header, true %>

<div class="main-content plan-form"
     data-controller="ui--navibar-resize suggestion-tab--area-draw"
     data-ui--navibar-resize-min-value="300"
     data-ui--navibar-resize-max-percent-value="80"
     data-ui--navibar-resize-default-value="350">
  <!-- 地図 -->
  <div id="map" class="map" data-map-mode="edit" data-plan-id="<%= plan.id %>" data-ui--navibar-resize-target="map"></div>

  <%# 地図上部のヘッダーバー（検索 + ジャンル/盛り上がり + ハンバーガー） %>
  <%= render "shared/map_header_bar" %>

  <!-- 地図上のフローティングボタン群 -->
  <div class="map-floating-buttons">
    <!-- コミュニティプランプレビュー閉じるボタン -->
    <button type="button"
            id="community-preview-close"
            class="map-floating-btn map-floating-btn--blue"
            hidden
            title="プレビューを閉じる"
            data-controller="community-tab--plan-preview"
            data-action="click->community-tab--plan-preview#hide">
      <i class="bi bi-x-lg" aria-hidden="true"></i>
      <i class="bi bi-share" aria-hidden="true"></i>
    </button>

    <!-- 検索結果クリアボタン -->
    <button type="button"
            id="search-hit-clear"
            class="map-floating-btn map-floating-btn--red"
            hidden
            title="検索結果をクリア"
            data-controller="ui--search-hit-clear"
            data-action="click->ui--search-hit-clear#clear">
      <i class="bi bi-x-lg" aria-hidden="true"></i>
      <i class="bi bi-search" aria-hidden="true"></i>
    </button>

    <!-- 提案ピンクリアボタン -->
    <button type="button"
            id="suggestion-pin-clear"
            class="map-floating-btn map-floating-btn--purple"
            hidden
            title="提案ピンをクリア"
            data-controller="suggestion-tab--pin-clear"
            data-action="click->suggestion-tab--pin-clear#clear">
      <i class="bi bi-x-lg" aria-hidden="true"></i>
      <i class="bi bi-stars" aria-hidden="true"></i>
    </button>

    <!-- 盛り上がりピンクリアボタン -->
    <button type="button"
            id="popular-spots-clear"
            class="map-floating-btn map-floating-btn--orange"
            hidden
            title="盛り上がりピンをクリア"
            data-controller="ui--popular-spots-clear"
            data-action="click->ui--popular-spots-clear#clear">
      <i class="bi bi-x-lg" aria-hidden="true"></i>
      <i class="bi bi-fire" aria-hidden="true"></i>
    </button>
  </div>

  <!-- デスクトップ用：地図下部中央のアクションボタン -->
  <%= turbo_frame_tag "map_bottom_actions" do %>
    <%= render "plans/map_bottom_actions", plan: plan %>
  <% end %>

  <!-- 左ナビバー（Turbo Frame化） -->
  <%= turbo_frame_tag "navibar" do %>
    <%= render "plans/navibar", plan: plan %>
  <% end %>

  <!-- ナビバーリサイズハンドル -->
  <div class="navibar-resize-handle"
       data-ui--navibar-resize-target="handle"
       data-action="mousedown->ui--navibar-resize#startResize touchstart->ui--navibar-resize#startResize click->ui--navibar-resize#handleClick">
    <div class="navibar-resize-handle__grip"></div>
  </div>

  <%# 提案エリア描画モーダル %>
  <%= render "suggestions/area_draw_modal" %>

  <%# 提案条件設定モーダル %>
  <%= render "suggestions/condition_modal", plan: plan %>
</div>

<%# InfoWindowスケルトンテンプレート（JSから参照） %>
<%= render "map/infowindow_skeleton" %>

<%# モバイル用InfoWindowボトムシート %>
<div id="mobile-infowindow"
     class="mobile-infowindow"
     data-controller="infowindow--mobile"
     hidden>
  <div class="mobile-infowindow__sheet" data-infowindow--mobile-target="sheet">
    <div class="mobile-infowindow__handle" data-infowindow--mobile-target="handle">
      <div class="mobile-infowindow__handle-bar"></div>
    </div>
    <div class="mobile-infowindow__content" id="mobile-infowindow-content">
      <%# InfoWindow コンテンツがここに挿入される（閉じるボタン含む） %>
    </div>
  </div>
</div>
