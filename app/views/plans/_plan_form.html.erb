<% content_for :body_class, "no-footer" %>

<div class="main-content plan-form"
     data-controller="navibar-resize"
     data-navibar-resize-min-value="300"
     data-navibar-resize-max-percent-value="88"
     data-navibar-resize-default-value="350">
  <!-- 地図 -->
  <div id="map" class="map" data-map-mode="edit" data-plan-id="<%= plan.id %>" data-navibar-resize-target="map"></div>

  <!-- 🔍 検索バー（地図上部に重ねる用） -->
  <div class="map-search-box">
    <input
      id="places-search-box"
      type="text"
      placeholder="地名やキーワードで検索"
      class="form-control"
    >
  </div>

  <!-- コミュニティプランプレビュー閉じるボタン -->
  <button type="button"
          id="community-preview-close"
          class="community-preview-close"
          hidden
          data-controller="community-plan-preview"
          data-action="click->community-plan-preview#hide">
    <i class="bi bi-x-lg" aria-hidden="true"></i>
    プレビューを閉じる
  </button>

  <!-- 左ナビバー（Turbo Frame化） -->
  <%= turbo_frame_tag "navibar" do %>
    <%= render "plans/navibar", plan: plan %>
  <% end %>

  <!-- リサイズハンドル -->
  <div class="navibar-resize-handle"
       data-navibar-resize-target="handle"
       data-action="mousedown->navibar-resize#startResize touchstart->navibar-resize#startResize click->navibar-resize#handleClick">
    <div class="navibar-resize-handle__grip"></div>
  </div>

  <!-- プラン保存ボタン＋モーダル（コントローラは外側のラッパーに） -->
  <div data-controller="plan-save-modal" data-plan-save-modal-plan-id-value="<%= plan.id %>">
    <div class="plan-save">
      <button type="button" class="btn btn-save" data-action="click->plan-save-modal#open">
        保存
      </button>
    </div>

    <!-- 保存モーダル（オーバーレイ）- transform影響を避けるためplan-saveの外に配置 -->
    <div class="plan-save-modal" data-plan-save-modal-target="modal" hidden>
      <div class="plan-save-modal__overlay" data-action="click->plan-save-modal#close"></div>
      <div class="plan-save-modal__dialog">
        <p class="plan-save-modal__message">名前をつけてプランを保存してください</p>
        <input
          type="text"
          class="form-control plan-save-modal__input"
          placeholder="プラン名を入力"
          data-plan-save-modal-target="input"
          data-action="keydown.enter->plan-save-modal#save"
        >
        <p class="plan-save-modal__error" data-plan-save-modal-target="error" hidden>プラン名を入力してください</p>
        <div class="plan-save-modal__actions">
          <button type="button" class="btn btn-cancel" data-action="click->plan-save-modal#close">キャンセル</button>
          <button type="button" class="btn btn-primary" data-action="click->plan-save-modal#save">保存</button>
        </div>
      </div>
    </div>
  </div>

</div>
