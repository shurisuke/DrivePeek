<%# 作ったプラン一覧（plans/my_plans#index） %>

<div class="list-page list-page--two-column">
  <h1 class="list-page__title">作ったプラン</h1>

  <div class="list-page__content">
  <%# 左サイドバー: 検索フォーム %>
  <div class="list-page__sidebar">
  <div class="search-box">
    <%= form_with url: plans_my_plans_path, method: :get, local: true do %>
      <div class="search-filters">
        <div class="multi-select" data-controller="multi-select" data-multi-select-name="cities[]" data-multi-select-placeholder-value="エリア">
          <button type="button" class="multi-select__trigger" data-action="click->multi-select#toggle" data-multi-select-target="trigger">
            <span data-multi-select-target="label" class="is-placeholder">エリア</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <div class="multi-select__dropdown" data-multi-select-target="dropdown">
            <% PlansHelper::PREFECTURES_BY_REGION.each do |region, prefs| %>
              <div class="multi-select__region">
                <div class="multi-select__region-label"><%= region %></div>
                <% prefs.each do |pref| %>
                  <% cities = @cities_by_prefecture[pref] || [] %>
                  <% if cities.any? %>
                    <div class="multi-select__prefecture-group" data-multi-select-target="prefectureGroup">
                      <div class="multi-select__prefecture-header" data-action="click->multi-select#togglePrefecture">
                        <div class="multi-select__prefecture-label">
                          <input type="checkbox"
                                 data-multi-select-target="prefectureCheckbox"
                                 data-action="click->multi-select#stopPropagation change->multi-select#selectPrefecture">
                          <span><%= pref %></span>
                        </div>
                        <i class="bi bi-chevron-right multi-select__expand-icon"></i>
                      </div>
                      <div class="multi-select__cities">
                        <% cities.each do |city| %>
                          <% city_value = "#{pref}/#{city}" %>
                          <label class="multi-select__option">
                            <input type="checkbox" value="<%= city_value %>" data-label="<%= city %>"
                                   data-multi-select-target="checkbox" data-action="change->multi-select#select"
                                   <%= 'checked' if @selected_cities&.include?(city_value) %>>
                            <span><%= city %></span>
                          </label>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
            <div class="multi-select__footer">
              <button type="button" class="multi-select__close-btn" data-action="click->multi-select#close">閉じる</button>
            </div>
          </div>
          <% @selected_cities&.each do |city| %>
            <input type="hidden" name="cities[]" value="<%= city %>" data-multi-select-target="hiddenField">
          <% end %>
        </div>
        <div class="multi-select" data-controller="multi-select" data-multi-select-name="genre_ids[]" data-multi-select-placeholder-value="ジャンル">
          <button type="button" class="multi-select__trigger" data-action="click->multi-select#toggle" data-multi-select-target="trigger">
            <span data-multi-select-target="label" class="is-placeholder">ジャンル</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <div class="multi-select__dropdown" data-multi-select-target="dropdown">
            <% @genres.each do |genre| %>
              <label class="multi-select__option">
                <input type="checkbox" value="<%= genre.id %>" data-label="<%= genre.name %>"
                       data-multi-select-target="checkbox" data-action="change->multi-select#select"
                       <%= 'checked' if @selected_genre_ids&.include?(genre.id) %>>
                <span><%= genre.name %></span>
              </label>
            <% end %>
            <div class="multi-select__footer">
              <button type="button" class="multi-select__close-btn" data-action="click->multi-select#close">閉じる</button>
            </div>
          </div>
          <% @selected_genre_ids&.each do |gid| %>
            <input type="hidden" name="genre_ids[]" value="<%= gid %>" data-multi-select-target="hiddenField">
          <% end %>
        </div>
      </div>

      <%= text_field_tag :q, @search_query,
                         placeholder: "フリーワード検索",
                         class: "search-input" %>

      <button type="submit" class="search-button">
        <i class="bi bi-search" aria-hidden="true"></i>
        <span>検索</span>
      </button>
    <% end %>
  </div>
  </div>

  <%# 右メイン: カード一覧 + ページネーション %>
  <div class="list-page__main">
  <% if @plans.present? %>
    <div class="list-page__cards">
      <% @plans.each do |plan| %>
        <%
          spots_data = plan.plan_spots.sort_by(&:position).map do |ps|
            spot = ps.spot
            {
              name: spot.name,
              address: spot.address,
              prefecture: spot.prefecture,
              city: spot.city
            }
          end
          # 全スポットからユニークなジャンル名を収集
          genre_names = plan.plan_spots.flat_map { |ps| ps.spot.genres.map(&:name) }.uniq
        %>
        <%= render "plans/plan_card",
                   plan_title: plan.title.presence || "無題のプラン",
                   spots: spots_data,
                   genres: genre_names,
                   total_duration: format_move_time(plan.spots_only_move_time),
                   total_distance: format_distance(plan.spots_only_distance),
                   is_favorite: false,
                   plan: plan,
                   can_edit: true,
                   can_delete: true %>
      <% end %>
    </div>

    <%# ページネーション %>
    <% if @plans.total_pages > 1 %>
      <div class="list-page__pagination">
        <%= paginate @plans %>
      </div>
    <% end %>
  <% else %>
    <div class="list-page__empty">
      <% if @search_query.present? || @selected_cities.present? || @selected_genre_ids.present? %>
        <p>条件に一致するプランが見つかりませんでした</p>
      <% else %>
        <p>まだプランがありません</p>
      <% end %>
    </div>
  <% end %>
  </div>
  </div>
</div>
