<%# みんなのプラン一覧（plans#index） %>

<div class="community-plans community-plans--index">
  <h1 class="community-plans__page-title">みんなの旅</h1>

  <div class="community-plans__content">
  <%# 検索フォーム %>
  <div class="community-plans__search">
    <%= form_with url: plans_path, method: :get, local: true do %>
      <%# 検索タイプ切り替えタブ %>
      <div class="community-plans__search-tabs">
        <label class="community-plans__search-tab <%= 'is-active' if @search_type != 'spot' %>">
          <input type="radio" name="search_type" value="plan" <%= 'checked' if @search_type != 'spot' %>
                 onchange="this.form.requestSubmit()">
          <span>プラン検索</span>
        </label>
        <label class="community-plans__search-tab <%= 'is-active' if @search_type == 'spot' %>">
          <input type="radio" name="search_type" value="spot" <%= 'checked' if @search_type == 'spot' %>
                 onchange="this.form.requestSubmit()">
          <span>スポット検索</span>
        </label>
      </div>

      <div class="community-plans__filters">
        <div class="multi-select" data-controller="multi-select" data-multi-select-name="cities[]" data-multi-select-placeholder-value="エリア">
          <button type="button" class="multi-select__trigger" data-action="click->multi-select#toggle" data-multi-select-target="trigger">
            <span data-multi-select-target="label" class="is-placeholder">エリア</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <div class="multi-select__dropdown" data-multi-select-target="dropdown">
            <% PlansHelper::PREFECTURES_BY_REGION.each do |region, prefs| %>
              <div class="multi-select__region">
                <div class="multi-select__region-label"><%= region %></div>
                <% prefs.each do |pref| %>
                  <% cities = @cities_by_prefecture[pref] || [] %>
                  <% if cities.any? %>
                    <div class="multi-select__prefecture-group" data-multi-select-target="prefectureGroup">
                      <div class="multi-select__prefecture-header" data-action="click->multi-select#togglePrefecture">
                        <div class="multi-select__prefecture-label">
                          <input type="checkbox"
                                 data-multi-select-target="prefectureCheckbox"
                                 data-action="click->multi-select#stopPropagation change->multi-select#selectPrefecture">
                          <span><%= pref %></span>
                        </div>
                        <i class="bi bi-chevron-right multi-select__expand-icon"></i>
                      </div>
                      <div class="multi-select__cities">
                        <% cities.each do |city| %>
                          <% city_value = "#{pref}/#{city}" %>
                          <label class="multi-select__option">
                            <input type="checkbox" value="<%= city_value %>" data-label="<%= city %>"
                                   data-multi-select-target="checkbox" data-action="change->multi-select#select"
                                   <%= 'checked' if @selected_cities&.include?(city_value) %>>
                            <span><%= city %></span>
                          </label>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
            <div class="multi-select__footer">
              <button type="button" class="multi-select__close-btn" data-action="click->multi-select#close">閉じる</button>
            </div>
          </div>
          <% @selected_cities&.each do |city| %>
            <input type="hidden" name="cities[]" value="<%= city %>" data-multi-select-target="hiddenField">
          <% end %>
        </div>
        <div class="multi-select" data-controller="multi-select" data-multi-select-name="genre_ids[]" data-multi-select-placeholder-value="ジャンル">
          <button type="button" class="multi-select__trigger" data-action="click->multi-select#toggle" data-multi-select-target="trigger">
            <span data-multi-select-target="label" class="is-placeholder">ジャンル</span>
            <i class="bi bi-chevron-down"></i>
          </button>
          <div class="multi-select__dropdown" data-multi-select-target="dropdown">
            <% @genres.each do |genre| %>
              <label class="multi-select__option">
                <input type="checkbox" value="<%= genre.id %>" data-label="<%= genre.name %>"
                       data-multi-select-target="checkbox" data-action="change->multi-select#select"
                       <%= 'checked' if @selected_genre_ids&.include?(genre.id) %>>
                <span><%= genre.name %></span>
              </label>
            <% end %>
            <div class="multi-select__footer">
              <button type="button" class="multi-select__close-btn" data-action="click->multi-select#close">閉じる</button>
            </div>
          </div>
          <% @selected_genre_ids&.each do |gid| %>
            <input type="hidden" name="genre_ids[]" value="<%= gid %>" data-multi-select-target="hiddenField">
          <% end %>
        </div>
      </div>

      <%= text_field_tag :q, @search_query,
                         placeholder: "フリーワード検索",
                         class: "community-plans__search-input" %>

      <button type="submit" class="community-plans__search-button">
        <i class="bi bi-search" aria-hidden="true"></i>
        <span>検索</span>
      </button>
    <% end %>
  </div>

  <% if @search_type == "spot" %>
    <%# スポット検索結果 %>
    <% if @community_spots.present? %>
      <% like_spots_map = like_spots_by_spot_id(@community_spots) %>
      <div class="community-plans__list">
        <% @community_spots.each do |spot| %>
          <%= render "plans/spot_card", spot: spot, like_spot: like_spots_map[spot.id] %>
        <% end %>
      </div>

      <%# ページネーション %>
      <% if @community_spots.total_pages > 1 %>
        <div class="community-plans__pagination">
          <%= paginate @community_spots %>
        </div>
      <% end %>
    <% else %>
      <div class="community-plans__empty">
        <% if @search_query.present? || @selected_cities.present? || @selected_genre_ids.present? %>
          <p>条件に一致するスポットが見つかりませんでした</p>
        <% else %>
          <p>まだスポットがありません</p>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <%# プラン検索結果 %>
    <% if @plans.present? %>
      <% like_plans_map = like_plans_by_plan_id(@plans) %>
      <div class="community-plans__list">
        <% @plans.each do |plan| %>
          <%
            # plan_spots を position 順で取得し、_plan_card 用のハッシュ形式に変換
            spots_data = plan.plan_spots.sort_by(&:position).map do |ps|
              spot = ps.spot
              {
                name: spot.name,
                address: spot.address
              }
            end
            # 全スポットからユニークなジャンル名を収集
            genre_names = plan.plan_spots.flat_map { |ps| ps.spot.genres.map(&:name) }.uniq
          %>
          <%= render "plans/plan_card",
                     plan_title: plan.title.presence || "無題のプラン",
                     spots: spots_data,
                     genres: genre_names,
                     total_duration: spots_only_formatted_move_time(plan),
                     total_distance: "#{spots_only_distance(plan)}km",
                     plan: plan,
                     like_plan: like_plans_map[plan.id],
                     can_delete: current_user&.id == plan.user_id %>
        <% end %>
      </div>

      <%# ページネーション %>
      <% if @plans.total_pages > 1 %>
        <div class="community-plans__pagination">
          <%= paginate @plans %>
        </div>
      <% end %>
    <% else %>
      <div class="community-plans__empty">
        <% if @search_query.present? || @selected_cities.present? || @selected_genre_ids.present? %>
          <p>条件に一致するプランが見つかりませんでした</p>
        <% else %>
          <p>まだ公開プランがありません</p>
        <% end %>
      </div>
    <% end %>
  <% end %>
  </div>
</div>
