<%# みんなのプラン一覧（plans#index） %>

<div class="list-page list-page--two-column">
  <h1 class="list-page__title">みんなの旅</h1>

  <div class="list-page__content">
  <%# 左サイドバー: 検索フォーム %>
  <div class="list-page__sidebar">
    <%= render "shared/search_form",
               form_url: plans_path,
               search_type: @search_type,
               selected_cities: @selected_cities,
               cities_by_prefecture: @cities_by_prefecture,
               genres_by_category: @genres_by_category,
               selected_genre_ids: @selected_genre_ids,
               search_query: @search_query %>
  </div>

  <%# 右メイン: カード一覧 + ページネーション %>
  <div class="list-page__main">
  <% if @search_type == "spot" %>
    <%# スポット検索結果 %>
    <% if @community_spots.present? %>
      <% favorite_spots_map = FavoriteSpot.index_by_spot_id(user: current_user, spot_ids: @community_spots.map(&:id)) %>
      <div class="list-page__cards">
        <% @community_spots.each do |spot| %>
          <%= render "plans/spot_card", spot: spot, favorite_spot: favorite_spots_map[spot.id] %>
        <% end %>
      </div>

      <%# ページネーション %>
      <% if @community_spots.total_pages > 1 %>
        <div class="list-page__pagination">
          <%= paginate @community_spots %>
        </div>
      <% end %>
    <% else %>
      <div class="list-page__empty">
        <% if @search_query.present? || @selected_cities.present? || @selected_genre_ids.present? %>
          <p>条件に一致するスポットが見つかりませんでした</p>
        <% else %>
          <p>まだスポットがありません</p>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <%# プラン検索結果 %>
    <% if @plans.present? %>
      <% favorite_plans_map = FavoritePlan.index_by_plan_id(user: current_user, plan_ids: @plans.map(&:id)) %>
      <div class="list-page__cards">
        <% @plans.each do |plan| %>
          <%
            # plan_spots を position 順で取得し、_plan_card 用のハッシュ形式に変換
            spots_data = plan.plan_spots.sort_by(&:position).map do |ps|
              spot = ps.spot
              {
                name: spot.name,
                address: spot.address,
                prefecture: spot.prefecture,
                city: spot.city
              }
            end
            # 全スポットからユニークなジャンル名を収集
            genre_names = plan.plan_spots.flat_map { |ps| ps.spot.genres.map(&:name) }.uniq
          %>
          <%= render "plans/plan_card",
                     plan_title: plan.title.presence || "無題のプラン",
                     spots: spots_data,
                     genres: genre_names,
                     total_duration: format_move_time(plan.spots_only_move_time),
                     total_distance: format_distance(plan.spots_only_distance),
                     plan: plan,
                     favorite_plan: favorite_plans_map[plan.id] %>
        <% end %>
      </div>

      <%# ページネーション %>
      <% if @plans.total_pages > 1 %>
        <div class="list-page__pagination">
          <%= paginate @plans %>
        </div>
      <% end %>
    <% else %>
      <div class="list-page__empty">
        <% if @search_query.present? || @selected_cities.present? || @selected_genre_ids.present? %>
          <p>条件に一致するプランが見つかりませんでした</p>
        <% else %>
          <p>まだ公開プランがありません</p>
        <% end %>
      </div>
    <% end %>
  <% end %>
  </div>
  </div>
</div>
