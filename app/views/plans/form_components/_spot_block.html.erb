<%# app/views/plans/form_components/_spot_block.html.erb %>
<%# locals: plan_spot:, user_spot: nil, like_spot: nil %>

<% spot = plan_spot.spot %>
<% tags = user_spot&.tags || [] %>

<div
  id="<%= dom_id(plan_spot) %>"
  class="spot-block"
  data-controller="plan-spot-memo plan-spot-tags plan-spot-delete"
  data-plan-spot-memo-url-value="<%= update_memo_plan_plan_spot_path(plan_spot.plan, plan_spot) %>"
  data-plan-spot-delete-plan-id-value="<%= plan_spot.plan_id %>"
  data-plan-spot-delete-plan-spot-id-value="<%= plan_spot.id %>"
  data-spot-id="<%= spot.id %>"
  data-plan-spot-id="<%= plan_spot.id %>"
  data-position="<%= plan_spot.position %>"
  data-lat="<%= spot.lat %>"
  data-lng="<%= spot.lng %>"
  data-user-spot-id="<%= user_spot&.id %>"
>
  <div class="spot-main">
    <div class="spot-order-pin" aria-hidden="true"><%= plan_spot.position %></div>

    <div class="spot-body">
      <% if spot.name.present? %>
        <div class="spot-name"><%= spot.name %></div>
      <% end %>

      <% if spot.address.present? %>
        <div class="spot-address"><%= spot.address %></div>
      <% end %>

      <%# ✅ タグ表示（Turbo差し替え対象） %>
      <%= turbo_frame_tag dom_id(plan_spot, :tag_chips),
                          class: "spot-tags",
                          data: {
                            plan_spot_tags_target: "chips",
                            action: "turbo:frame-render->plan-spot-tags#syncEditingUI"
                          } do %>
        <%= render "plan_spots/tags/chips", plan: plan_spot.plan, plan_spot: plan_spot, tags: tags %>
      <% end %>

      <%# ✅ 表示用メモ枠（削除ボタンあり） %>
      <div class="spot-memo spot-memo--pin <%= "d-none" if plan_spot.memo.blank? %>"
           data-plan-spot-memo-target="memoDisplay">

        <button type="button"
                class="spot-memo__delete"
                aria-label="メモを削除"
                data-action="pointerdown->plan-spot-memo#stopPropagation click->plan-spot-memo#clear">
          ×
        </button>

        <div class="spot-memo__content" data-plan-spot-memo-target="memoContent">
          <%= simple_format(h(plan_spot.memo.to_s)) %>
        </div>
      </div>
    </div>
  </div>

  <div class="spot-detail-wrap">
    <div class="collapse spot-detail"
         id="spotDetail-<%= plan_spot.id %>"
         data-plan-spot-memo-target="detail">
      <div class="spot-detail__inner">

        <%# ✅ 編集用メモ枠（閉じる不具合修正版） %>
        <div class="spot-memo spot-memo--pin spot-memo--editor d-none"
             data-plan-spot-memo-target="editor"
             data-action="pointerdown->plan-spot-memo#stopPropagation click->plan-spot-memo#stopPropagation">

          <form data-action="submit->plan-spot-memo#submit">
            <textarea class="form-control"
                      rows="2"
                      placeholder="メモを入力"
                      data-plan-spot-memo-target="textarea"
                      data-action="pointerdown->plan-spot-memo#stopPropagation click->plan-spot-memo#focusTextarea"><%= plan_spot.memo.to_s %></textarea>

            <div class="spot-memo__editor-actions">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-action="pointerdown->plan-spot-memo#stopPropagation click->plan-spot-memo#close"
              >
                閉じる
              </button>

              <button
                type="submit"
                class="btn btn-personal"
                data-action="pointerdown->plan-spot-memo#stopPropagation"
              >
                追加
              </button>
            </div>
          </form>
        </div>

        <div class="spot-detail-actions">
          <%# ✅ フォームを「ボタンの上」に出すためのラッパー（縦積み用） %>
          <div class="spot-detail-actions__buttons-wrap">

            <%# ✅ タグ追加フォーム（メモと同じCSS枠 / 入力できるようにイベント伝播停止） %>
            <div class="spot-memo spot-memo--pin spot-memo--editor d-none"
                 data-plan-spot-tags-target="form"
                 data-action="pointerdown->plan-spot-tags#stopPropagation click->plan-spot-tags#stopPropagation">

              <%= form_with(
                    url: plan_plan_spot_tags_path(plan_spot.plan, plan_spot),
                    method: :post,
                    data: {
                      turbo_frame: dom_id(plan_spot, :tag_chips),
                      action: "turbo:submit-end->plan-spot-tags#afterSubmit"
                    }
                  ) do |f| %>

                <%= f.text_field :tag_name,
                                 name: "tag[tag_name]",
                                 class: "form-control",
                                 placeholder: "タグを追加",
                                 autocomplete: "off",
                                 data: {
                                   plan_spot_tags_target: "input",
                                   action: "pointerdown->plan-spot-tags#stopPropagation click->plan-spot-tags#stopPropagation keydown->plan-spot-tags#stopPropagation"
                                 } %>

                <div class="spot-memo__editor-actions">
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    data-action="pointerdown->plan-spot-tags#stopPropagation click->plan-spot-tags#close"
                  >
                    閉じる
                  </button>

                  <button
                    type="submit"
                    class="btn btn-personal"
                    data-action="pointerdown->plan-spot-tags#stopPropagation"
                  >
                    追加
                  </button>
                </div>
              <% end %>
            </div>

            <%# ✅ ボタン列（左→右：お気に入り / メモ / タグ / 削除） %>
            <div class="spot-detail-actions__buttons">
              <%= render "like_spots/button", spot: spot, like_spot: like_spot %>

              <button type="button"
                      class="btn btn-outline-secondary btn-sm w-100"
                      data-action="click->plan-spot-memo#open">
                <i class="bi bi-journal-text me-1" aria-hidden="true"></i>
              </button>

              <button type="button"
                      class="btn btn-outline-secondary btn-sm w-100"
                      data-action="click->plan-spot-tags#toggle"
                      aria-label="タグを編集">
                <i class="bi bi-tag me-1" aria-hidden="true"></i>
              </button>

              <%# ✅ スポット削除（Turbo Stream で remove） %>
              <%= form_with(
                    url: plan_plan_spot_path(plan_spot.plan, plan_spot),
                    method: :delete,
                    class: "d-inline w-100",
                    data: {
                      turbo_confirm: "このスポットを削除しますか？",
                      action: "turbo:submit-end->plan-spot-delete#afterSubmit pointerdown->plan-spot-memo#stopPropagation"
                    }
                  ) do %>
                <button type="submit"
                        class="btn btn-outline-secondary btn-sm w-100"
                        aria-label="スポットを削除">
                  <i class="bi bi-x-lg me-1 spot-delete-icon" aria-hidden="true"></i>
                </button>
              <% end %>
            </div>

          </div>
        </div>

        <div class="trip-summary mt-3">
          <div class="trip-info">
            <span class="label">有料道路</span>

            <div class="toll-switch">
              <div class="form-check form-switch m-0">
                <input
                  class="form-check-input"
                  type="checkbox"
                  role="switch"
                  aria-label="有料道路の使用を切り替える"
                  data-toll-used-switch="1"
                  data-plan-id="<%= plan_spot.plan_id %>"
                  data-plan-spot-id="<%= plan_spot.id %>"
                  <%= 'checked="checked"' if plan_spot.toll_used? %>
                >
              </div>
            </div>

            <span class="price">¥ 〇〇〇〇</span>
          </div>

          <div class="distance-info">
            <span>次の場所まで</span>
            <span class="km">〇〇km</span>
            <span class="time">〇〇h 〇〇m</span>
          </div>
        </div>

      </div>
    </div>

    <button
      type="button"
      class="detail-toggle"
      data-bs-toggle="collapse"
      data-bs-target="#spotDetail-<%= plan_spot.id %>"
      aria-expanded="false"
      aria-controls="spotDetail-<%= plan_spot.id %>"
    >
      <i class="bi bi-caret-down-fill"></i>
    </button>
  </div>
</div>