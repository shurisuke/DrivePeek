<%# app/views/plans/form_components/_spot_block.html.erb %>
<%# locals: plan_spot:, user_spot: nil %>

<% spot = plan_spot.spot %>
<% tags = user_spot&.tags || [] %>

<div
  class="spot-block"
  data-spot-id="<%= spot.id %>"
  data-plan-spot-id="<%= plan_spot.id %>"
  data-position="<%= plan_spot.position %>"
  data-user-spot-id="<%= user_spot&.id %>"
>
  <div class="spot-main">
    <!-- positionピン（左上） -->
    <div class="spot-order-pin" aria-hidden="true"><%= plan_spot.position %></div>

    <!-- お気に入り（右上） -->
    <button type="button" class="spot-fav-btn" aria-label="お気に入り">
      <i class="bi bi-heart"></i>
    </button>

    <!-- 中央：スポット名 / 住所 / タグ / メモ枠 -->
    <div class="spot-body">
      <% if spot.name.present? %>
        <div class="spot-name"><%= spot.name %></div>
      <% end %>

      <% if spot.address.present? %>
        <div class="spot-address"><%= spot.address %></div>
      <% end %>

      <div class="spot-tags">
        <% tags.each do |tag| %>
          <span class="tag-chip"><%= tag.tag_name %></span>
        <% end %>
      </div>

      <div class="spot-memo">
        <div class="spot-memo__label">メモ</div>
        <div class="spot-memo__placeholder">（後ほど実装予定）</div>
      </div>
    </div>
  </div>

  <%# ✅ トグル領域は常に描画する %>
  <div class="spot-detail-wrap">
    <div class="collapse spot-detail" id="spotDetail-<%= plan_spot.id %>">
      <div class="spot-detail__inner">
        <div class="spot-detail-actions">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100">
            <i class="bi bi-journal-text me-1" aria-hidden="true"></i>
            メモ
          </button>

          <button type="button" class="btn btn-outline-secondary btn-sm w-100">
            <i class="bi bi-tag me-1" aria-hidden="true"></i>
            タグ
          </button>
        </div>

        <div class="toll-option d-flex align-items-center justify-content-between">
          <label class="mb-0 me-2">有料道路</label>

          <%# ✅ switch UI（変更検知はJSでイベント委譲） %>
          <div class="form-check form-switch m-0">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              aria-label="有料道路の使用を切り替える"
              data-toll-used-switch="1"
             data-plan-id="<%= plan_spot.plan_id %>"
              data-plan-spot-id="<%= plan_spot.id %>"
              <%= 'checked="checked"' if plan_spot.toll_used? %>
            >
          </div>
        </div>

        <div class="distance-info d-flex align-items-center justify-content-between">
          <span>次の場所まで</span>
          <span class="km">〇〇km</span>
          <span class="time">〇〇時間〇〇分</span>
        </div>
      </div>
    </div>

    <button
      type="button"
      class="detail-toggle"
      data-bs-toggle="collapse"
      data-bs-target="#spotDetail-<%= plan_spot.id %>"
      aria-expanded="false"
      aria-controls="spotDetail-<%= plan_spot.id %>"
    >
      <i class="bi bi-caret-down-fill"></i>
    </button>
  </div>
</div>