<%# みんなのプランタブ: プランカード一覧（実データ） %>

<div class="community-plans">
  <% if @community_plans.present? %>
    <div class="community-plans__list">
      <% @community_plans.each do |plan| %>
        <%
          # plan_spots を position 順で取得し、_plan_card 用のハッシュ形式に変換
          spots_data = plan.plan_spots.sort_by(&:position).map do |ps|
            spot = ps.spot
            # ユーザーのuser_spotsからタグを取得
            user_spot = plan.user.user_spots.find { |us| us.spot_id == spot.id }
            tag_names = user_spot&.tags&.map { |tag| t("google_place_types.#{tag.tag_name}", default: tag.tag_name) } || []

            {
              name: spot.name,
              address: spot.address,
              tags: tag_names
            }
          end
        %>
        <%= render "plans/plan_card",
                   plan_title: plan.title.presence || "無題のプラン",
                   spots: spots_data,
                   total_duration: plan.formatted_move_time,
                   total_distance: "#{plan.total_distance}km",
                   is_favorite: false %>
      <% end %>
    </div>
  <% else %>
    <div class="community-plans__empty">
      <p>まだ公開プランがありません</p>
    </div>
  <% end %>
</div>
