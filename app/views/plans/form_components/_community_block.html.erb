<%# みんなのプランタブ: プランカード一覧（実データ） %>

<%= turbo_frame_tag "community_plans" do %>
  <div class="community-plans">
    <%# 検索フォーム %>
    <div class="community-plans__search">
      <form action="<%= edit_plan_path(@plan) %>" method="get" data-turbo-frame="community_plans">
        <div class="community-plans__filters">
          <div class="multi-select" data-controller="multi-select" data-multi-select-name="cities[]" data-multi-select-placeholder-value="エリア">
            <button type="button" class="multi-select__trigger" data-action="click->multi-select#toggle" data-multi-select-target="trigger">
              <span data-multi-select-target="label" class="is-placeholder">エリア</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <div class="multi-select__dropdown" data-multi-select-target="dropdown">
              <% PlansHelper::PREFECTURES_BY_REGION.each do |region, prefs| %>
                <div class="multi-select__region">
                  <div class="multi-select__region-label"><%= region %></div>
                  <% prefs.each do |pref| %>
                    <% cities = @cities_by_prefecture[pref] || [] %>
                    <% if cities.any? %>
                      <div class="multi-select__prefecture-group" data-multi-select-target="prefectureGroup">
                        <div class="multi-select__prefecture-header" data-action="click->multi-select#togglePrefecture">
                          <div class="multi-select__prefecture-label">
                            <input type="checkbox"
                                   data-multi-select-target="prefectureCheckbox"
                                   data-action="click->multi-select#stopPropagation change->multi-select#selectPrefecture">
                            <span><%= pref %></span>
                          </div>
                          <i class="bi bi-chevron-right multi-select__expand-icon"></i>
                        </div>
                        <div class="multi-select__cities">
                          <% cities.each do |city| %>
                            <% city_value = "#{pref}/#{city}" %>
                            <label class="multi-select__option">
                              <input type="checkbox" value="<%= city_value %>" data-label="<%= city %>"
                                     data-multi-select-target="checkbox" data-action="change->multi-select#select"
                                     <%= 'checked' if @selected_cities&.include?(city_value) %>>
                              <span><%= city %></span>
                            </label>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
              <div class="multi-select__footer">
                <button type="button" class="multi-select__close-btn" data-action="click->multi-select#close">閉じる</button>
              </div>
            </div>
            <% @selected_cities&.each do |city| %>
              <input type="hidden" name="cities[]" value="<%= city %>" data-multi-select-target="hiddenField">
            <% end %>
          </div>
          <div class="multi-select" data-controller="multi-select" data-multi-select-name="genre_ids[]" data-multi-select-placeholder-value="ジャンル">
            <button type="button" class="multi-select__trigger" data-action="click->multi-select#toggle" data-multi-select-target="trigger">
              <span data-multi-select-target="label" class="is-placeholder">ジャンル</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <div class="multi-select__dropdown" data-multi-select-target="dropdown">
              <% @genres.each do |genre| %>
                <label class="multi-select__option">
                  <input type="checkbox" value="<%= genre.id %>" data-label="<%= genre.name %>"
                         data-multi-select-target="checkbox" data-action="change->multi-select#select"
                         <%= 'checked' if @selected_genre_ids&.include?(genre.id) %>>
                  <span><%= genre.name %></span>
                </label>
              <% end %>
              <div class="multi-select__footer">
                <button type="button" class="multi-select__close-btn" data-action="click->multi-select#close">閉じる</button>
              </div>
            </div>
            <% @selected_genre_ids&.each do |gid| %>
              <input type="hidden" name="genre_ids[]" value="<%= gid %>" data-multi-select-target="hiddenField">
            <% end %>
          </div>
        </div>

        <%= text_field_tag :q, @search_query,
                           placeholder: "フリーワード検索",
                           class: "community-plans__search-input" %>

        <button type="submit" class="community-plans__search-button">
          <i class="bi bi-search" aria-hidden="true"></i>
          <span>検索</span>
        </button>
      </form>
    </div>
    <% if @community_plans.present? %>
      <div class="community-plans__list">
        <% @community_plans.each do |plan| %>
          <%
            # plan_spots を position 順で取得し、_plan_card 用のハッシュ形式に変換
            spots_data = plan.plan_spots.sort_by(&:position).map do |ps|
              spot = ps.spot
              {
                name: spot.name,
                address: spot.address
              }
            end
            # 全スポットからユニークなジャンル名を収集
            genre_names = plan.plan_spots.flat_map { |ps| ps.spot.genres.map(&:name) }.uniq
          %>
          <%= render "plans/plan_card",
                     plan_title: plan.title.presence || "無題のプラン",
                     spots: spots_data,
                     genres: genre_names,
                     total_duration: spots_only_formatted_move_time(plan),
                     total_distance: "#{spots_only_distance(plan)}km",
                     is_favorite: false %>
        <% end %>
      </div>

      <%# ページネーション %>
      <% if @community_plans.total_pages > 1 %>
        <div class="community-plans__pagination">
          <%= paginate @community_plans %>
        </div>
      <% end %>
    <% else %>
      <div class="community-plans__empty">
        <% if @search_query.present? || @selected_prefectures.present? || @selected_genre_ids.present? %>
          <p>条件に一致するプランが見つかりませんでした</p>
        <% else %>
          <p>まだ公開プランがありません</p>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
