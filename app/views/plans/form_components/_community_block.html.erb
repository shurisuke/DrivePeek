<%# みんなのプランタブ: プランカード一覧（実データ） %>

<%= turbo_frame_tag "community_plans" do %>
  <div class="community-plans">
    <%# 検索フォーム %>
    <div class="community-plans__search">
      <form action="<%= edit_plan_path(@plan) %>" method="get" data-turbo-frame="community_plans">
        <div class="community-plans__search-input-wrapper">
          <%= text_field_tag :q, @search_query,
                             placeholder: "地名・スポット名・住所などでフリーワード検索",
                             class: "community-plans__search-input" %>
          <button type="submit" class="community-plans__search-button">
            <i class="bi bi-search" aria-hidden="true"></i>
          </button>
        </div>
      </form>
    </div>
    <% if @community_plans.present? %>
      <div class="community-plans__list">
        <% @community_plans.each do |plan| %>
          <%
            # plan_spots を position 順で取得し、_plan_card 用のハッシュ形式に変換
            spots_data = plan.plan_spots.sort_by(&:position).map do |ps|
              spot = ps.spot
              {
                name: spot.name,
                address: spot.address
              }
            end
          %>
          <%= render "plans/plan_card",
                     plan_title: plan.title.presence || "無題のプラン",
                     spots: spots_data,
                     total_duration: spots_only_formatted_move_time(plan),
                     total_distance: "#{spots_only_distance(plan)}km",
                     is_favorite: false %>
        <% end %>
      </div>

      <%# ページネーション %>
      <% if @community_plans.total_pages > 1 %>
        <div class="community-plans__pagination">
          <%= paginate @community_plans %>
        </div>
      <% end %>
    <% else %>
      <div class="community-plans__empty">
        <% if @search_query.present? %>
          <p>「<%= @search_query %>」に一致するプランが見つかりませんでした</p>
        <% else %>
          <p>まだ公開プランがありません</p>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
