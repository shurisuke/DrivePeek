<%# ================================================================
    Planタブ（単一責務）
    用途: 出発地点 + プラン内スポット一覧（position順）を描画する
    メモ: spot-block の並び替え（SortableJS）の親コンテナを提供する
================================================================ %>

<%= render "plans/form_components/start_point_block" %>

<% spot_ids = @plan.plan_spots.select(:spot_id) %>

<% user_spots_by_spot_id =
     current_user.user_spots
       .includes(user_spot_tags: :tag)
       .where(spot_id: spot_ids)
       .index_by(&:spot_id)
%>

<% like_spots_by_spot_id =
     current_user.like_spots
       .where(spot_id: spot_ids)
       .index_by(&:spot_id)
%>

<%# ✅ SortableJS の「親要素」(この中の .spot-block が入れ替わる) %>
<div id="plan-spots-sortable" data-sortable="plan-spots">
  <% @plan.plan_spots.includes(:spot).order(:position).each do |plan_spot| %>
    <%= render "plans/form_components/spot_block",
               plan_spot:  plan_spot,
               user_spot:  user_spots_by_spot_id[plan_spot.spot_id],
               like_spot:  like_spots_by_spot_id[plan_spot.spot_id] %>
  <% end %>
</div>

<%# ✅ 帰宅地点は「スポットの有無」ではなく、トグル操作で表示/非表示を管理する %>
<%= render "plans/form_components/goal_point_block", plan: @plan %>