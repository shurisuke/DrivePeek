<%# ================================================================
    Planタブ（単一責務）
    用途: 出発地点 + プラン内スポット一覧（position順）を描画する
    メモ: spot-block の並び替え（SortableJS）の親コンテナを提供する
================================================================ %>

<%= render "plans/form_components/start_point_block" %>

<%# スポット未追加時のみ案内を表示 %>
<% if @plan.plan_spots.empty? %>
  <%= render "plans/form_components/plan_tab_guide" %>
<% end %>

<% spot_ids = @plan.plan_spots.select(:spot_id) %>

<% like_spots_by_spot_id =
     current_user.like_spots
       .where(spot_id: spot_ids)
       .index_by(&:spot_id)
%>

<%# ✅ SortableJS の「親要素」(この中の .spot-block が入れ替わる) %>
<div id="plan-spots-sortable" data-sortable="plan-spots">
  <% @plan.plan_spots.includes(spot: :genres).order(:position).each do |plan_spot| %>
    <%= render "plans/form_components/spot_block",
               plan_spot:  plan_spot,
               like_spot:  like_spots_by_spot_id[plan_spot.spot_id] %>
  <% end %>
</div>

<%# ✅ 帰宅地点は「スポットの有無」ではなく、トグル操作で表示/非表示を管理する %>
<%= render "plans/form_components/goal_point_block", plan: @plan %>

<%# ✅ 出発・帰宅時間サマリー（時刻レールON + 帰宅地点ON時のみ表示） %>
<div class="plan-time-summary-section">
  <div class="plan-time-summary">
    <div class="plan-time-summary__item">
      <span class="plan-time-summary__label">出発</span>
      <span class="plan-time-summary__value"><%= @plan.start_point&.departure_time&.strftime("%H:%M") || "--:--" %></span>
    </div>
    <div class="plan-time-summary__item plan-time-summary__item--goal">
      <span class="plan-time-summary__label">帰宅</span>
      <span class="plan-time-summary__value"><%= @plan.goal_point&.arrival_time&.strftime("%H:%M") || "--:--" %></span>
    </div>
  </div>
</div>