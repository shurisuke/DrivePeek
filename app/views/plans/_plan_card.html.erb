<%# プランカード（一覧表示用の共通部品） %>
<%# locals: plan_title:, spots: [], total_duration: nil, total_distance: nil, plan: nil, like_plan: nil, can_delete: false, can_edit: false, genres: [], preview_mode: false %>

<div class="plan-card">
  <div class="plan-card__header">
    <h3 class="plan-card__title"><%= plan_title %></h3>
    <div class="plan-card__actions">
      <% if local_assigns[:plan] %>
        <%= render "like_plans/button", plan: plan, like_plan: like_plan %>
      <% end %>
      <% if local_assigns[:can_edit] && local_assigns[:plan] %>
        <%= link_to edit_plan_path(plan),
              class: "plan-card__edit",
              aria: { label: "プランを編集" } do %>
          <i class="bi bi-pencil" aria-hidden="true"></i>
        <% end %>
      <% end %>
      <% if local_assigns[:can_delete] && local_assigns[:plan] %>
        <%= button_to plan_path(plan), method: :delete,
              class: "plan-card__delete",
              aria: { label: "プランを削除" },
              data: { turbo_confirm: "このプランを削除しますか？" } do %>
          <i class="bi bi-trash" aria-hidden="true"></i>
        <% end %>
      <% end %>
    </div>
  </div>

  <% if local_assigns[:genres].present? %>
    <div class="plan-card__genres">
      <% genres.each do |genre_name| %>
        <span class="plan-card__genre"><%= genre_name %></span>
      <% end %>
    </div>
  <% end %>

  <div class="plan-card__spots">
    <% if spots.present? %>
      <% spots.each_with_index do |spot, index| %>
        <% if local_assigns[:preview_mode] && spot[:lat].present? && spot[:lng].present? %>
          <div class="plan-card__spot plan-card__spot--clickable"
               data-controller="single-spot-preview"
               data-single-spot-preview-lat-value="<%= spot[:lat] %>"
               data-single-spot-preview-lng-value="<%= spot[:lng] %>"
               data-single-spot-preview-name-value="<%= spot[:name] %>"
               data-single-spot-preview-address-value="<%= spot[:address] %>"
               data-action="click->single-spot-preview#show"
               role="button"
               tabindex="0">
            <span class="plan-card__spot-number"><%= index + 1 %></span>
            <div class="plan-card__spot-info">
              <div class="plan-card__spot-name"><%= spot[:name] %></div>
              <% if spot[:address].present? %>
                <div class="plan-card__spot-address"><%= spot[:address] %></div>
              <% end %>
            </div>
            <span class="plan-card__spot-pin" aria-hidden="true">
              <i class="bi bi-geo-alt"></i>
            </span>
          </div>
        <% else %>
          <div class="plan-card__spot">
            <span class="plan-card__spot-number"><%= index + 1 %></span>
            <div class="plan-card__spot-info">
              <div class="plan-card__spot-name"><%= spot[:name] %></div>
              <% if spot[:address].present? %>
                <div class="plan-card__spot-address"><%= spot[:address] %></div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    <% else %>
      <div class="plan-card__no-spots">スポットなし</div>
    <% end %>
  </div>

  <div class="plan-card__footer">
    <div class="plan-card__totals">
      <% if total_duration.present? %>
        <span class="plan-card__total-item">
          <i class="bi bi-clock" aria-hidden="true"></i>
          <%= total_duration %>
        </span>
      <% end %>
      <% if total_distance.present? %>
        <span class="plan-card__total-item">
          <i class="bi bi-signpost-2" aria-hidden="true"></i>
          <%= total_distance %>
        </span>
      <% end %>
    </div>
    <% if local_assigns[:plan] %>
      <% if local_assigns[:preview_mode] %>
        <%# 編集画面内：地図にプレビュー表示 %>
        <button type="button"
                class="plan-card__detail-link"
                aria-label="ルートをプレビュー"
                data-controller="community-plan-preview"
                data-community-plan-preview-plan-id-value="<%= plan.id %>"
                data-action="click->community-plan-preview#show">
          <i class="bi bi-map" aria-hidden="true"></i>
          ルートを見る
        </button>
      <% else %>
        <%# 一覧画面：詳細ページへ遷移 %>
        <%= link_to plan_path(plan), class: "plan-card__detail-link", aria: { label: "プラン詳細を見る" } do %>
          <i class="bi bi-geo-alt" aria-hidden="true"></i>
          地図で見る
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>
