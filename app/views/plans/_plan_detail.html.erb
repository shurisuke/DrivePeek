<% content_for :body_class, "no-footer" %>
<% content_for :hide_header, true %>

<script>
  window.planData = <%= raw(json_escape(@plan.marker_data_for_public_view.to_json)) %>;
</script>

<div class="main-content plan-detail"
     data-controller="ui--navibar-resize"
     data-ui--navibar-resize-min-value="300"
     data-ui--navibar-resize-max-percent-value="80"
     data-ui--navibar-resize-default-value="350"
     data-ui--navibar-resize-storage-key-value="drive_peek:navibar_detail_width"
     data-ui--navibar-resize-collapsed-key-value="drive_peek:navibar_detail_collapsed"
     data-ui--navibar-resize-slide-key-value="drive_peek:navibar_detail_slide">
  <%# InfoWindowスケルトンテンプレート（JSから参照） %>
  <%= render "map/infowindow_skeleton" %>

  <!-- 地図 -->
  <div id="map" class="map"
       data-map-mode="show"
       data-plan-id="<%= @plan.id %>"
       data-user-signed-in="<%= user_signed_in? %>"
       data-ui--navibar-resize-target="map"></div>

  <%# 地図上部のヘッダーバー（検索 + ジャンル/盛り上がり + ハンバーガー） %>
  <%= render "shared/map_header_bar" %>

  <!-- デスクトップ用：地図下部中央のアクションボタン -->
  <div class="map-bottom-actions">
    <% if current_user %>
      <button type="button"
              class="map-bottom-actions__btn map-bottom-actions__btn--copy map-bottom-actions__btn--single"
              data-controller="ui--create-plan-trigger"
              data-ui--create-plan-trigger-url-value="<%= plans_path(copy_from: @plan.id) %>"
              data-action="click->ui--create-plan-trigger#create">
        このプランで作る
      </button>
    <% else %>
      <%= link_to new_user_session_path, class: "map-bottom-actions__btn map-bottom-actions__btn--copy map-bottom-actions__btn--single" do %>
        このプランで作る
      <% end %>
    <% end %>
  </div>

  <!-- 検索結果クリアボタン -->
  <div class="map-floating-buttons">
    <button type="button"
            id="search-hit-clear"
            class="map-floating-btn map-floating-btn--red"
            hidden
            title="検索結果をクリア"
            data-controller="ui--search-hit-clear"
            data-action="click->ui--search-hit-clear#clear">
      <i class="bi bi-x-lg" aria-hidden="true"></i>
      <i class="bi bi-search" aria-hidden="true"></i>
    </button>
  </div>

  <!-- リサイズハンドル -->
  <div class="navibar-resize-handle"
       data-ui--navibar-resize-target="handle"
       data-action="mousedown->ui--navibar-resize#startResize touchstart->ui--navibar-resize#startResize click->ui--navibar-resize#handleClick">
    <div class="navibar-resize-handle__grip"></div>
  </div>

  <!-- ナビバー（詳細用・1タブ） -->
  <aside class="navibar navibar--show"
         data-controller="ui--bottom-sheet"
         data-ui--bottom-sheet-min-value="8"
         data-ui--bottom-sheet-mid-value="45"
         data-ui--bottom-sheet-max-value="85"
         data-ui--bottom-sheet-state-value="mid">
    <%# モバイル用ドラッグハンドル %>
    <div class="navibar__handle">
      <div class="navibar__handle-bar"></div>
    </div>

    <div class="navibar__content">
      <div class="navibar__content-scroll">
        <div class="navibar__header">
          <%= link_to :back, class: "plan-detail__back-link" do %>
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
          <% end %>
          <h1 class="navibar__title"><%= plan_title(@plan) %></h1>
          <button type="button"
                  class="plan-detail__share-btn"
                  data-controller="ui--share-modal"
                  data-ui--share-modal-url-value="<%= plan_url(@plan) %>"
                  data-ui--share-modal-text-value="<%= share_text_for_plan(@plan) %>"
                  data-action="click->ui--share-modal#open">
            <i class="bi bi-box-arrow-up" aria-hidden="true"></i>
          </button>
        </div>
        <div class="navibar__blocks">
          <%# ✅ 2カラムレイアウト: スポットブロック + 時刻レール（readonly） %>
          <div class="plan-tab-layout plan-tab-layout--readonly" data-controller="plan-tab--time-rail-sync">
            <%# 左カラム: スポットブロック %>
            <div class="plan-tab-content">
              <% plan_spots = @plan.plan_spots.includes(spot: :genres).order(:position).to_a %>
              <% spot_ids = plan_spots.map(&:spot_id) %>
              <% favorite_spots_map = current_user ? FavoriteSpot.index_by_spot_id(user: current_user, spot_ids: spot_ids) : {} %>
              <% plan_spots.each_with_index do |plan_spot, index| %>
                <%= render "plans/spot_block",
                           plan_spot: plan_spot,
                           favorite_spot: favorite_spots_map[plan_spot.spot_id],
                           readonly: true,
                           is_first: index == 0,
                           is_last: index == plan_spots.size - 1 %>
              <% end %>

              <%# 帰宅ラベル（時刻レール用スペーサー付き） %>
              <div class="goal-point-block goal-point-block--label-only"
                   data-plan-tab--time-rail-sync-target="content"
                   data-time-rail-sync="goal-label">
                <div class="goal-content">
                  <div class="goal-header">
                    <span class="goal-icon" aria-hidden="true"></span>
                    <span class="goal-title">帰宅</span>
                    <div class="goal-spacer" aria-hidden="true"></div>
                  </div>
                </div>
              </div>
            </div>

            <%# 右カラム: 時刻レール %>
            <div class="plan-tab-time-rail">
              <%= render "plans/time_rail", plan: @plan, readonly: true %>
            </div>
          </div>

          <%# 関連プラン %>
          <% if @related_plans.any? %>
            <div class="related-section">
              <h2 class="related-section__title">このエリアの他のプラン</h2>
              <div class="related-section__list">
                <% @related_plans.each do |related_plan| %>
                  <%= render "plans/plan_card", plan: related_plan, preview_mode: true %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="navibar__footer">
      <%# ✅ アクションボタン（plan-tab-actions と同じ形式） %>
      <div class="plan-tab-actions">
        <div class="plan-tab-actions__group">
          <button type="button"
                  class="plan-tab-actions__btn plan-tab-actions__btn--copy plan-tab-actions__btn--single"
                  data-controller="ui--create-plan-trigger"
                  data-ui--create-plan-trigger-copy-from-value="<%= @plan.id %>"
                  data-action="click->ui--create-plan-trigger#create">
            このプランで作る
          </button>
        </div>
      </div>
    </div>
  </aside>

  <%# モバイル用InfoWindowボトムシート %>
  <div id="mobile-infowindow"
       class="mobile-infowindow"
       data-controller="infowindow--mobile"
       hidden>
    <div class="mobile-infowindow__sheet" data-infowindow--mobile-target="sheet">
      <div class="mobile-infowindow__handle" data-infowindow--mobile-target="handle">
        <div class="mobile-infowindow__handle-bar"></div>
      </div>
      <div class="mobile-infowindow__content" id="mobile-infowindow-content">
        <%# InfoWindow コンテンツがここに挿入される（閉じるボタン含む） %>
      </div>
    </div>
  </div>
</div>
