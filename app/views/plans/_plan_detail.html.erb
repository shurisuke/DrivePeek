<% content_for :body_class, "no-footer" %>
<% content_for :hide_header, true %>

<script>
  window.planData = <%= raw(json_escape(@plan.marker_data_for_public_view.to_json)) %>;
</script>

<div class="main-content plan-detail"
     data-controller="ui--navibar-resize"
     data-ui--navibar-resize-min-value="300"
     data-ui--navibar-resize-max-percent-value="80"
     data-ui--navibar-resize-default-value="350"
     data-ui--navibar-resize-storage-key-value="drive_peek:navibar_detail_width"
     data-ui--navibar-resize-collapsed-key-value="drive_peek:navibar_detail_collapsed"
     data-ui--navibar-resize-slide-key-value="drive_peek:navibar_detail_slide">
  <%# InfoWindowスケルトンテンプレート（JSから参照） %>
  <%= render "map/infowindow_skeleton" %>

  <!-- 地図 -->
  <div id="map" class="map" data-map-mode="show" data-plan-id="<%= @plan.id %>" data-ui--navibar-resize-target="map"></div>

  <%# 地図上部のヘッダーバー（検索 + ジャンル/盛り上がり + ハンバーガー） %>
  <%= render "shared/map_header_bar" %>

  <!-- 検索結果クリアボタン -->
  <div class="map-floating-buttons">
    <button type="button"
            id="search-hit-clear"
            class="map-floating-btn map-floating-btn--red"
            hidden
            title="検索結果をクリア"
            data-controller="ui--search-hit-clear"
            data-action="click->ui--search-hit-clear#clear">
      <i class="bi bi-x-lg" aria-hidden="true"></i>
      <i class="bi bi-search" aria-hidden="true"></i>
    </button>
  </div>

  <!-- リサイズハンドル -->
  <div class="navibar-resize-handle"
       data-ui--navibar-resize-target="handle"
       data-action="mousedown->ui--navibar-resize#startResize touchstart->ui--navibar-resize#startResize click->ui--navibar-resize#handleClick">
    <div class="navibar-resize-handle__grip"></div>
  </div>

  <!-- ナビバー（詳細用・1タブ） -->
  <aside class="navibar navibar--show"
         data-controller="ui--bottom-sheet"
         data-ui--bottom-sheet-min-value="8"
         data-ui--bottom-sheet-mid-value="45"
         data-ui--bottom-sheet-max-value="85"
         data-ui--bottom-sheet-state-value="mid">
    <%# モバイル用ドラッグハンドル %>
    <div class="navibar__handle">
      <div class="navibar__handle-bar"></div>
    </div>

    <div class="navibar__content">
      <div class="navibar__content-scroll">
        <div class="navibar__header">
          <%= link_to :back, class: "plan-detail__back-link" do %>
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
          <% end %>
          <h1 class="navibar__title"><%= plan_title(@plan) %></h1>
          <button type="button"
                  class="plan-detail__share-btn"
                  data-controller="ui--share-modal"
                  data-ui--share-modal-url-value="<%= plan_url(@plan) %>"
                  data-ui--share-modal-text-value="<%= share_text_for_plan(@plan) %>"
                  data-action="click->ui--share-modal#open">
            <i class="bi bi-box-arrow-up" aria-hidden="true"></i>
          </button>
        </div>
        <div class="navibar__blocks">
          <%= render "plans/plan_content_show", plan: @plan %>
        </div>
      </div>
    </div>

    <div class="navibar__footer">
      <% if @plan.plan_spots.size >= 2 %>
        <div class="plan-summary">
          <div class="plan-summary__item">
            <i class="bi bi-signpost-2" aria-hidden="true"></i>
            <span class="plan-summary__value"><%= @plan.spots_only_distance %></span>
            <span class="plan-summary__unit">km</span>
          </div>
          <div class="plan-summary__item">
            <i class="bi bi-clock" aria-hidden="true"></i>
            <span class="plan-summary__value"><%= format_move_time(@plan.spots_only_move_time) %></span>
          </div>
        </div>
      <% end %>
    </div>
  </aside>

  <%# モバイル用InfoWindowボトムシート %>
  <div id="mobile-infowindow"
       class="mobile-infowindow"
       data-controller="infowindow--mobile"
       hidden>
    <div class="mobile-infowindow__sheet" data-infowindow--mobile-target="sheet">
      <div class="mobile-infowindow__handle" data-infowindow--mobile-target="handle">
        <div class="mobile-infowindow__handle-bar"></div>
      </div>
      <div class="mobile-infowindow__content" id="mobile-infowindow-content">
        <%# InfoWindow コンテンツがここに挿入される（閉じるボタン含む） %>
      </div>
    </div>
  </div>
</div>
