<%# app/views/plans/_goal_point_block.html.erb %>
<% plan ||= @plan %>
<% goal_point = plan.goal_point %>

<div
  class="goal-point-section"
  data-controller="goal-point-visibility"
  data-goal-point-visibility-plan-id-value="<%= plan.id %>"
>
  <div data-goal-point-visibility-target="blockArea" hidden>
    <div class="goal-point-block"
         data-controller="goal-point-editor"
         data-lat="<%= goal_point&.lat %>"
         data-lng="<%= goal_point&.lng %>">
      <%# ✅ 左側: 既存コンテンツ（350px） %>
      <div class="block-main-content">
        <div class="goal-point-main">
          <span class="goal-point-icon" aria-hidden="true"></span>

          <div class="goal-label">
            <div class="goal-title-row">
              <span class="goal-title">帰宅</span>

              <button
                type="button"
                class="goal-point-change-btn"
                data-goal-point-editor-target="toggle"
                data-action="click->goal-point-editor#toggle"
                aria-expanded="false"
                aria-controls="goal-point-edit-<%= plan.id %>"
              >
                <i class="bi bi-pencil-fill" aria-hidden="true"></i>
                <span class="visually-hidden">帰宅地点を変更</span>
              </button>
            </div>

            <span class="address" data-goal-point-editor-target="address">
              <%= goal_point&.address.presence || "帰宅地点が未設定です" %>
            </span>
          </div>

          <button type="button"
                  class="point-map-btn"
                  data-point-type="goal"
                  data-controller="navibar-marker-button"
                  data-action="click->navibar-marker-button#point"
                  aria-label="地図で表示">
            <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
          </button>
        </div>

        <div
          id="goal-point-edit-<%= plan.id %>"
          class="goal-point-edit"
          hidden
          data-goal-point-editor-target="editArea"
        >
          <div class="goal-point-edit__inner">
            <label for="goal-point-address-<%= plan.id %>" class="goal-point-edit__label">帰宅地点を変更</label>

            <input
              id="goal-point-address-<%= plan.id %>"
              type="text"
              class="form-control goal-point-edit__input"
              placeholder="（例: 〇〇市〇〇町〇〇-〇）"
              autocomplete="off"
              data-goal-point-editor-target="input"
              data-action="keydown->goal-point-editor#search compositionstart->goal-point-editor#compositionStart compositionend->goal-point-editor#compositionEnd"
            >

            <div class="goal-point-edit__help">Enterで検索 → 更新</div>

            <button
              type="button"
              class="point-edit__cancel-btn"
              data-action="click->goal-point-editor#toggle"
            >
              キャンセル
            </button>
          </div>
        </div>
      </div>

      <%# ✅ 右側: 時刻パネル（ON時のみ表示 / 矢印なし） %>
      <div class="block-time-panel">
        <div class="block-time-panel__main">
          <div class="block-time-panel__row block-time-panel__row--arrival">
            <span class="block-time-panel__label block-time-panel__label--arrival">到着</span>
            <span class="block-time-panel__value block-time-panel__value--arrival"><%= goal_point&.arrival_time&.strftime("%H:%M") || "--:--" %></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% if plan.plan_spots.exists? %>
    <%# ✅ 帰宅地点トグル（出発地点の有料道路トグルと同じ見た目に統一） %>
    <div class="goal-point-toggle-row">
      <span class="label">帰宅地点</span>

      <div class="toll-switch">
        <div class="form-check form-switch m-0">
          <input
            class="form-check-input"
            type="checkbox"
            role="switch"
            id="goal-point-visibility-switch-<%= plan.id %>"
            aria-label="帰宅地点の表示を切り替える"
            data-goal-point-visibility-target="switch"
            data-action="change->goal-point-visibility#toggle"
          >
        </div>
      </div>
    </div>
  <% end %>
</div>