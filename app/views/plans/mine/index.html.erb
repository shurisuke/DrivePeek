<%# 作ったプラン一覧（plans/mine#index） %>

<div class="list-page list-page--two-column">
  <h1 class="list-page__title">作ったプラン</h1>

  <div class="list-page__content">
  <%# 左サイドバー: 検索フォーム %>
  <div class="list-page__sidebar">
    <%= render "shared/search_form",
               form_url: plans_mine_index_path,
               show_tabs: false,
               selected_cities: @selected_cities,
               cities_by_prefecture: @cities_by_prefecture,
               genres_by_category: @genres_by_category,
               selected_genre_ids: @selected_genre_ids,
               search_query: @search_query %>
  </div>

  <%# 右メイン: カード一覧 + ページネーション %>
  <div class="list-page__main">
  <% if @plans.present? %>
    <div class="list-page__cards">
      <% @plans.each do |plan| %>
        <%
          spots_data = plan.plan_spots.sort_by(&:position).map do |ps|
            spot = ps.spot
            {
              name: spot.name,
              address: spot.address,
              prefecture: spot.prefecture,
              city: spot.city
            }
          end
          # 全スポットからユニークなジャンル名を収集
          genre_names = plan.plan_spots.flat_map { |ps| ps.spot.genres.map(&:name) }.uniq
        %>
        <%= render "plans/plan_card",
                   plan_title: plan_title(plan),
                   spots: spots_data,
                   genres: genre_names,
                   total_duration: format_move_time(plan.spots_only_move_time),
                   total_distance: format_distance(plan.spots_only_distance),
                   is_favorite: false,
                   plan: plan,
                   can_edit: true,
                   can_delete: true %>
      <% end %>
    </div>

    <%# ページネーション %>
    <% if @plans.total_pages > 1 %>
      <div class="list-page__pagination">
        <%= paginate @plans %>
      </div>
    <% end %>
  <% else %>
    <div class="list-page__empty">
      <% if @search_query.present? || @selected_cities.present? || @selected_genre_ids.present? %>
        <p>条件に一致するプランが見つかりませんでした</p>
      <% else %>
        <p>まだプランがありません</p>
      <% end %>
    </div>
  <% end %>
  </div>
  </div>
</div>
