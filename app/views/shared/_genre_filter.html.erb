<%# ジャンルフィルタ（親子関係対応） %>
<%# 必要な変数: genres_by_category, selected_genre_ids %>

<div class="multi-select" data-controller="multi-select" data-multi-select-placeholder-value="ジャンル">
  <div class="multi-select__trigger" data-action="click->multi-select#toggle" data-multi-select-target="trigger">
    <input type="text" class="multi-select__input" placeholder="ジャンル"
           data-action="input->multi-select#filter focus->multi-select#open"
           data-multi-select-target="searchInput label">
    <i class="bi bi-chevron-down"></i>
  </div>
  <div class="multi-select__dropdown" data-multi-select-target="dropdown">
    <% genres_by_category.each do |category, genre_groups| %>
      <div class="multi-select__region" data-multi-select-target="region">
        <div class="multi-select__region-label"><%= category %></div>
        <% genre_groups.each do |group| %>
          <% genre = group[:genre] %>
          <% children = group[:children] %>
          <% if children.present? %>
            <%# 子ジャンルがある場合は展開可能なグループ %>
            <div class="multi-select__parent-group" data-multi-select-target="parentGroup">
              <div class="multi-select__parent-header" data-action="click->multi-select#toggleParent">
                <div class="multi-select__parent-label">
                  <input type="checkbox"
                         data-multi-select-target="parentCheckbox"
                         data-action="click->multi-select#stopPropagation change->multi-select#selectParent">
                  <span><%= genre.name %></span>
                </div>
                <i class="bi bi-chevron-right multi-select__expand-icon"></i>
              </div>
              <div class="multi-select__children">
                <% children.each do |child| %>
                  <label class="multi-select__option">
                    <input type="checkbox" name="genre_ids[]" value="<%= child.id %>" data-label="<%= child.name %>"
                           data-multi-select-target="checkbox" data-action="change->multi-select#select"
                           <%= 'checked' if selected_genre_ids&.include?(child.id) %>>
                    <span><%= child.name %></span>
                  </label>
                <% end %>
              </div>
            </div>
          <% else %>
            <%# 子ジャンルがない場合は単独のオプション %>
            <label class="multi-select__option">
              <input type="checkbox" name="genre_ids[]" value="<%= genre.id %>" data-label="<%= genre.name %>"
                     data-multi-select-target="checkbox" data-action="change->multi-select#select"
                     <%= 'checked' if selected_genre_ids&.include?(genre.id) %>>
              <span><%= genre.name %></span>
            </label>
          <% end %>
        <% end %>
      </div>
    <% end %>
    <div class="multi-select__footer">
      <button type="button" class="multi-select__close-btn" data-action="click->multi-select#close">閉じる</button>
    </div>
  </div>
</div>
