<%# スポットカード（検索結果表示用の共通部品） %>
<%# locals: spot:, favorite_spot: nil, spot_stats: nil %>

<%
  _spot_stats = local_assigns.fetch(:spot_stats, nil)
  spot_location = format_spot_location(spot)

  # プリロード済みデータがあれば使用（N+1回避）
  if _spot_stats
    plans_count = _spot_stats[:plans_count]
    comment_count = _spot_stats[:comments_count]
    favorite_count = _spot_stats[:favorites_count]
  else
    plans_count = spot.plans.count
    comment_count = spot.spot_comments.count
    favorite_count = spot.favorite_spots.count
  end
%>

<div class="spot-card">
  <%# ヘッダー: 名前・ジャンル + アクションボタン %>
  <div class="spot-card__header">
    <div class="spot-card__title-block">
      <h3 class="spot-card__name"><%= spot.name %></h3>
      <% if spot.genres.any? %>
        <div class="spot-card__genres">
          <% spot.genres.each do |genre| %>
            <span class="spot-card__genre"><%= genre.name %></span>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="spot-card__actions-zone">
      <%# お気に入りボタン（数値付き） %>
      <div class="spot-card__stat">
        <%= render "favorite_spots/button", spot: spot, favorite_spot: favorite_spot %>
        <span id="<%= dom_id(spot, :favorite_count) %>" class="spot-card__stat-count"><%= favorite_count %></span>
      </div>
      <%# コメントボタン（数値付き） %>
      <div class="spot-card__stat">
        <button type="button"
                class="spot-card__comment-btn"
                data-controller="infowindow--comment-open"
                data-infowindow--comment-open-spot-id-value="<%= spot.id %>"
                data-infowindow--comment-open-place-id-value="<%= spot.place_id %>"
                data-infowindow--comment-open-lat-value="<%= spot.lat %>"
                data-infowindow--comment-open-lng-value="<%= spot.lng %>"
                data-infowindow--comment-open-name-value="<%= spot.name %>"
                data-infowindow--comment-open-address-value="<%= spot.address %>"
                data-action="click->infowindow--comment-open#openComment">
          <i class="bi bi-chat"></i>
        </button>
        <span id="<%= dom_id(spot, :comment_count) %>" class="spot-card__stat-count"><%= comment_count %></span>
      </div>
    </div>
  </div>

  <%# 場所 %>
  <% if spot_location.present? %>
    <div class="spot-card__location">
      <i class="bi bi-geo-alt" aria-hidden="true"></i>
      <%= spot_location %>
    </div>
  <% end %>

  <%# フッター %>
  <div class="spot-card__footer">
    <div class="spot-card__plans-count">
      <i class="fa-solid fa-car" aria-hidden="true"></i>
      <span><%= plans_count %></span>人がドライブ
    </div>

    <% has_location = spot.lat.present? && spot.lng.present? && spot.place_id.present? %>
    <%# プレビューボタン（ナビバー内で表示） %>
    <% if has_location %>
      <button type="button"
              class="spot-card__map-link spot-card__map-link--preview"
              aria-label="地図でこのスポットを見る"
              data-controller="community-tab--single-spot-preview"
              data-community-tab--single-spot-preview-lat-value="<%= spot.lat %>"
              data-community-tab--single-spot-preview-lng-value="<%= spot.lng %>"
              data-community-tab--single-spot-preview-name-value="<%= spot.name %>"
              data-community-tab--single-spot-preview-address-value="<%= spot.address %>"
              data-community-tab--single-spot-preview-place-id-value="<%= spot.place_id %>"
              data-community-tab--single-spot-preview-genres-value="<%= spot.genres.first(2).map(&:name).to_json %>"
              data-action="click->community-tab--single-spot-preview#show">
        <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
        地図で見る
      </button>
    <% end %>
    <%# 地図で見るリンク（スタンドアロンページで表示） %>
    <%= link_to spot_path(spot), class: "spot-card__map-link spot-card__map-link--view#{' spot-card__map-link--only' unless has_location}", data: { turbo_frame: "_top" }, aria: { label: "スポット詳細を見る" } do %>
      <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
      地図で見る
    <% end %>
  </div>
</div>
