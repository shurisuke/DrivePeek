<%# 検索フォーム（モード切替式） %>
<%# 必要な変数: form_url, selected_cities, cities_by_prefecture, genres_by_category, selected_genre_ids, search_query %>

<div class="search-box" data-controller="community--search-mode">
  <%= form_with url: form_url, method: :get, local: true, data: local_assigns[:turbo_frame] ? { turbo_frame: turbo_frame } : {} do %>

    <%# ========== 通常モード ========== %>
    <div data-community--search-mode-target="main">
      <% if local_assigns.fetch(:show_tabs, true) %>
        <div class="search-tabs">
          <label class="search-tabs__tab <%= 'is-active' if local_assigns[:search_type] != 'spot' %>">
            <input type="radio" name="search_type" value="plan" <%= 'checked' if local_assigns[:search_type] != 'spot' %>
                   onchange="this.form.requestSubmit()">
            <span>プラン</span>
          </label>
          <label class="search-tabs__tab <%= 'is-active' if local_assigns[:search_type] == 'spot' %>">
            <input type="radio" name="search_type" value="spot" <%= 'checked' if local_assigns[:search_type] == 'spot' %>
                   onchange="this.form.requestSubmit()">
            <span>スポット</span>
          </label>
        </div>
      <% end %>

      <div class="search-filters">
        <%# エリア選択ボタン %>
        <button type="button" class="search-filters__select-btn" data-action="click->community--search-mode#showArea">
          <span data-community--search-mode-target="areaLabel"><%= format_selected_cities(selected_cities, cities_by_prefecture) %></span>
          <i class="bi bi-plus"></i>
        </button>

        <%# ジャンル選択ボタン %>
        <button type="button" class="search-filters__select-btn" data-action="click->community--search-mode#showGenre">
          <span data-community--search-mode-target="genreLabel"><%= format_selected_genres(selected_genre_ids, genres_by_category) %></span>
          <i class="bi bi-plus"></i>
        </button>
      </div>

      <%= text_field_tag :q, search_query, placeholder: "フリーワード検索", class: "search-input" %>

      <% if local_assigns[:show_favorites_toggle] %>
        <label class="search-filters__toggle">
          <input type="checkbox" name="favorites_only" value="1"
                 <%= 'checked' if local_assigns[:favorites_only] %>
                 onchange="this.form.requestSubmit()">
          <span class="search-filters__toggle-switch"></span>
          <span>お気に入りのみ</span>
        </label>
      <% end %>

      <button type="submit" class="search-button <%= local_assigns[:button_class] %>">
        <i class="bi bi-search"></i>
        <span>検索</span>
      </button>
    </div>

    <%# ========== エリア選択モード ========== %>
    <div hidden data-community--search-mode-target="area">
      <div class="selection-list">
        <% PlansHelper::PREFECTURES_BY_REGION.each do |region, prefs| %>
          <div class="selection-list__region">
            <div class="selection-list__region-label"><%= region %></div>
            <% prefs.each do |pref| %>
              <% cities = cities_by_prefecture[pref] || [] %>
              <% if cities.any? %>
                <div class="selection-list__group" data-parent-group>
                  <div class="selection-list__parent" data-action="click->community--search-mode#toggleParent">
                    <input type="checkbox" data-parent-checkbox
                           data-action="click->community--search-mode#selectParent">
                    <span><%= pref %></span>
                    <i class="bi bi-chevron-down selection-list__toggle"
                       data-action="click->community--search-mode#toggleGroup"></i>
                  </div>
                  <div class="selection-list__children">
                    <% cities.each do |city| %>
                      <% city_value = "#{pref}/#{city}" %>
                      <label class="selection-list__item">
                        <input type="checkbox" name="cities[]" value="<%= city_value %>"
                               data-action="change->community--search-mode#updateParent"
                               <%= 'checked' if selected_cities&.include?(city_value) %>>
                        <span><%= city %></span>
                      </label>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>

      <button type="button" class="selection-done-btn" data-action="click->community--search-mode#back">
        エリアを決定
      </button>
    </div>

    <%# ========== ジャンル選択モード ========== %>
    <div hidden data-community--search-mode-target="genre">
      <div class="selection-list">
        <% genres_by_category.each do |category, genre_groups| %>
          <div class="selection-list__region">
            <div class="selection-list__region-label"><%= category %></div>
            <% genre_groups.each do |group| %>
              <% genre = group[:genre] %>
              <% children = group[:children] %>
              <% if children.present? %>
                <div class="selection-list__group" data-parent-group>
                  <div class="selection-list__parent" data-action="click->community--search-mode#toggleParent">
                    <input type="checkbox" data-parent-checkbox
                           data-action="click->community--search-mode#selectParent">
                    <span><%= genre.name %></span>
                    <i class="bi bi-chevron-down selection-list__toggle"
                       data-action="click->community--search-mode#toggleGroup"></i>
                  </div>
                  <div class="selection-list__children">
                    <% children.each do |child| %>
                      <label class="selection-list__item">
                        <input type="checkbox" name="genre_ids[]" value="<%= child.id %>"
                               data-action="change->community--search-mode#updateParent"
                               <%= 'checked' if selected_genre_ids&.include?(child.id) %>>
                        <span><%= child.name %></span>
                      </label>
                    <% end %>
                  </div>
                </div>
              <% else %>
                <label class="selection-list__item">
                  <input type="checkbox" name="genre_ids[]" value="<%= genre.id %>"
                         <%= 'checked' if selected_genre_ids&.include?(genre.id) %>>
                  <span><%= genre.name %></span>
                </label>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>

      <button type="button" class="selection-done-btn" data-action="click->community--search-mode#back">
        ジャンルを決定
      </button>
    </div>

  <% end %>
</div>
