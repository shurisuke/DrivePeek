<%# プランカード（一覧表示用の共通部品） %>
<%# locals: plan:, favorite_plan: nil, can_delete: false, can_edit: false %>

<%
  _can_edit = local_assigns.fetch(:can_edit, false)
  _can_delete = local_assigns.fetch(:can_delete, false)
  _plan = plan
  _favorite_plan = local_assigns.fetch(:favorite_plan, nil)
  favorite_count = _plan.favorite_plans.size

  # planから導出
  _plan_title = plan_title(_plan)
  _spots = _plan.plan_spots.includes(spot: :genres).order(:position).map do |ps|
    { name: ps.spot.name, prefecture: ps.spot.prefecture, city: ps.spot.city,
      lat: ps.spot.lat, lng: ps.spot.lng, address: ps.spot.address,
      place_id: ps.spot.place_id, genres: ps.spot.genres.map(&:name) }
  end
  _genres = _spots.flat_map { |s| s[:genres] }.uniq.first(3)
  _total_duration = format_move_time(_plan.spots_only_move_time)
  _total_distance = format_distance(_plan.spots_only_distance)
%>

<div class="plan-card">
  <%# ヘッダー：タイトル・ジャンル + アクション + お気に入り %>
  <div class="plan-card__header">
    <div class="plan-card__title-block">
      <h3 class="plan-card__title"><%= _plan_title %></h3>
      <% if _genres.present? %>
        <div class="plan-card__genres">
          <% _genres.each do |genre_name| %>
            <span class="plan-card__genre"><%= genre_name %></span>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="plan-card__header-actions">
      <% if _can_delete %>
        <div class="plan-card__actions">
          <% if _can_delete && _plan %>
            <%= button_to plan_path(_plan), method: :delete,
                  class: "plan-card__action plan-card__action--delete",
                  aria: { label: "プランを削除" },
                  data: { turbo_confirm: "このプランを削除しますか？" } do %>
              <i class="bi bi-trash" aria-hidden="true"></i>
            <% end %>
          <% end %>
        </div>
      <% end %>
      <%# 共有ボタン（スポットがある場合のみ） %>
      <% if _plan&.plan_spots&.any? %>
        <button type="button"
                class="plan-card__action plan-card__action--share"
                aria-label="シェア"
                data-controller="ui--share-modal"
                data-ui--share-modal-url-value="<%= plan_url(_plan) %>"
                data-ui--share-modal-text-value="<%= share_text_for_plan(_plan) %>"
                data-action="click->ui--share-modal#open">
          <i class="bi bi-three-dots" aria-hidden="true"></i>
        </button>
      <% end %>
      <% if _plan %>
        <div class="plan-card__stats">
          <div class="plan-card__stat">
            <%= render "favorite_plans/button", plan: _plan, favorite_plan: _favorite_plan %>
            <span id="<%= dom_id(_plan, :favorite_count) %>" class="plan-card__stat-count"><%= favorite_count %></span>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# スポット一覧 %>
  <div class="plan-card__spots">
    <% if _spots.present? %>
      <% _spots.each_with_index do |spot, index| %>
        <% spot_location = format_spot_location(spot) %>
        <% has_location = spot[:lat].present? && spot[:lng].present? %>
        <%# クリック可能版（ナビバー内で表示） %>
        <% if has_location %>
          <div class="plan-card__spot plan-card__spot--clickable plan-card__spot--preview"
               data-controller="community-tab--single-spot-preview"
               data-community-tab--single-spot-preview-lat-value="<%= spot[:lat] %>"
               data-community-tab--single-spot-preview-lng-value="<%= spot[:lng] %>"
               data-community-tab--single-spot-preview-name-value="<%= spot[:name] %>"
               data-community-tab--single-spot-preview-address-value="<%= spot[:address] %>"
               data-community-tab--single-spot-preview-place-id-value="<%= spot[:place_id] %>"
               data-community-tab--single-spot-preview-genres-value="<%= (spot[:genres] || []).to_json %>"
               data-action="click->community-tab--single-spot-preview#show"
               role="button"
               tabindex="0">
            <span class="plan-card__spot-number"><%= index + 1 %></span>
            <span class="plan-card__spot-name"><%= spot[:name] %></span>
            <% if spot_location.present? %>
              <span class="plan-card__spot-location"><%= spot_location %></span>
            <% end %>
          </div>
        <% end %>
        <%# 通常版（スタンドアロンページで表示） %>
        <div class="plan-card__spot plan-card__spot--view<%= ' plan-card__spot--only' unless has_location %>">
          <span class="plan-card__spot-number"><%= index + 1 %></span>
          <span class="plan-card__spot-name"><%= spot[:name] %></span>
          <% if spot_location.present? %>
            <span class="plan-card__spot-location"><%= spot_location %></span>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <div class="plan-card__no-spots">スポットなし</div>
    <% end %>
  </div>

  <%# フッター %>
  <div class="plan-card__footer<%= ' plan-card__footer--long' if long_duration?(_plan.spots_only_move_time) %>">
    <div class="plan-card__totals">
      <% if _total_duration.present? %>
        <span class="plan-card__total-item">
          <i class="bi bi-clock" aria-hidden="true"></i>
          <span><%= _total_duration %></span>
        </span>
      <% end %>
      <% if _total_distance.present? %>
        <span class="plan-card__total-item">
          <i class="bi bi-signpost-2" aria-hidden="true"></i>
          <span><%= _total_distance %><span class="plan-card__unit">km</span></span>
        </span>
      <% end %>
    </div>
    <% if _plan %>
      <%# 編集リンク（スタンドアロン + 所有者のみ表示、CSSで制御） %>
      <% if _can_edit %>
        <%= link_to edit_plan_path(_plan), class: "plan-card__detail-link plan-card__detail-link--edit", data: { turbo_frame: "_top" }, aria: { label: "プランを編集" } do %>
          編集する
          <i class="bi bi-pencil" aria-hidden="true"></i>
        <% end %>
      <% end %>
      <%# ルートプレビューボタン（ナビバー内で表示、CSSで制御） %>
      <button type="button"
              class="plan-card__detail-link plan-card__detail-link--preview"
              aria-label="ルートをプレビュー"
              data-controller="community-tab--plan-preview"
              data-community-tab--plan-preview-spots-value="<%= plan_preview_spots_json(_spots) %>"
              data-community-tab--plan-preview-polylines-value="<%= plan_preview_polylines_json(_plan) %>"
              data-action="click->community-tab--plan-preview#show">
        <i class="bi bi-share" aria-hidden="true"></i>
        ルート
      </button>
      <%# 地図で見るリンク（スタンドアロン + 非所有者のみ表示、CSSで制御） %>
      <% unless _can_edit %>
        <%= link_to plan_path(_plan), class: "plan-card__detail-link plan-card__detail-link--view", data: { turbo_frame: "_top" }, aria: { label: "プラン詳細を見る" } do %>
          地図で見る
          <i class="bi bi-chevron-right" aria-hidden="true"></i>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>
