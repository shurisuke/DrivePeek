<%#
  InfoWindow コンテンツ（スポット用）

  locals:
    - spot: Spotモデル
    - photo_urls: 写真URL配列
    - show_button: 「プランに追加」ボタン表示
    - button_label: ボタンラベル
    - map_mode: 地図モード（"show" = 詳細画面）
    - plan_id: プランID
    - plan_spot_id: 削除モード時のID
    - zoom_scale: ズームスケール
    - zoom_index: ズームインデックス
%>
<%
  safe_name = spot.name.presence || "名称不明"
  safe_address = spot.address.presence || "住所不明"
  urls = photo_urls.presence || []
  has_multiple_photos = urls.size > 1
  comments = spot.spot_comments.chronological.includes(:user)
  comment_count = comments.size
  favorite_spot = current_user.favorite_spots.find_by(spot: spot)
%>

<%= turbo_frame_tag "infowindow-content" do %>
<div class="dp-infowindow dp-infowindow--<%= zoom_scale %>"
     data-controller="infowindow--ui"
     data-infowindow--ui-zoom-scales-value="<%= infowindow_zoom_scales_json %>"
     data-infowindow--ui-zoom-index-value="<%= zoom_index %>">

  <%# タブ切り替え用ラジオボタン %>
  <% _default_tab = local_assigns[:default_tab] %>
  <input type="radio" name="iw-tab" id="iw-tab-info" class="dp-infowindow__tab-radio" <%= "checked" unless _default_tab == "comment" %>>
  <input type="radio" name="iw-tab" id="iw-tab-comment" class="dp-infowindow__tab-radio" <%= "checked" if _default_tab == "comment" %>>

  <%# ヘッダー %>
  <div class="dp-infowindow__header">
    <div class="dp-infowindow__tabs">
      <label for="iw-tab-info" class="dp-infowindow__tab">スポット</label>
      <label for="iw-tab-comment" class="dp-infowindow__tab">コメント</label>
    </div>
    <div class="dp-infowindow__stats">
      <%= render "favorite_spots/infowindow_button", spot: spot, favorite_spot: favorite_spot %>
      <label for="iw-tab-comment" class="dp-infowindow__stat dp-infowindow__stat--comment">
        <i class="bi bi-chat"></i>
        <span id="comment-count"><%= comment_count %></span>
      </label>
      <button type="button"
              class="dp-infowindow__close"
              onclick="this.closest('.gm-style-iw-a')?.querySelector('button.gm-ui-hover-effect')?.click()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>

  <%# ズームコントロール %>
  <div class="dp-infowindow__zoom-controls">
    <button type="button"
            class="dp-infowindow__zoom-btn"
            data-action="click->infowindow--ui#zoomOut"
            data-infowindow--ui-target="zoomOutBtn">
      <i class="bi bi-dash"></i>
    </button>
    <button type="button"
            class="dp-infowindow__zoom-btn"
            data-action="click->infowindow--ui#zoomIn"
            data-infowindow--ui-target="zoomInBtn">
      <i class="bi bi-plus"></i>
    </button>
  </div>

  <%# スポット情報パネル %>
  <div class="dp-infowindow__panel dp-infowindow__panel--info">
    <%# 写真エリア %>
    <% if urls.any? %>
      <div class="dp-infowindow__photo">
        <div class="dp-infowindow__slider" data-infowindow--ui-target="slider">
          <% urls.each_with_index do |url, i| %>
            <div class="dp-infowindow__slide<%= ' dp-infowindow__slide--active' if i == 0 %>"
                 data-index="<%= i %>">
              <img class="dp-infowindow__img" src="<%= url %>" alt="<%= safe_name %>">
            </div>
          <% end %>
        </div>

        <% if has_multiple_photos %>
          <button type="button"
                  class="dp-infowindow__arrow dp-infowindow__arrow--prev"
                  data-action="click->infowindow--ui#prevSlide">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button type="button"
                  class="dp-infowindow__arrow dp-infowindow__arrow--next"
                  data-action="click->infowindow--ui#nextSlide">
            <i class="bi bi-chevron-right"></i>
          </button>
        <% end %>

        <% if spot.place_id.present? %>
          <button type="button"
                  class="dp-infowindow__expand-btn"
                  data-action="click->infowindow--ui#openGallery">
            <i class="bi bi-arrows-fullscreen"></i>
          </button>
        <% end %>

        <% if has_multiple_photos %>
          <div class="dp-infowindow__indicator" data-infowindow--ui-target="indicator">
            <% urls.each_with_index do |_, i| %>
              <span class="dp-infowindow__dot<%= ' dp-infowindow__dot--active' if i == 0 %>"
                    data-index="<%= i %>"
                    data-action="click->infowindow--ui#goToSlide"></span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="dp-infowindow__photo dp-infowindow__photo--empty">
        <i class="bi bi-image"></i>
      </div>
    <% end %>

    <%# ジャンルタグ（Turbo Frameで遅延ロード） %>
    <div class="dp-infowindow__genres">
      <%= render "spots/genres_inline", spot: spot %>
    </div>

    <%# 本文 %>
    <div class="dp-infowindow__body">
      <div class="dp-infowindow__name"><%= safe_name %></div>
      <div class="dp-infowindow__address"><%= safe_address %></div>

      <% if map_mode == "show" %>
        <%# プラン詳細画面: ボタンなし（地図下部の「このプランで作る」ボタンを使用） %>
      <% elsif map_mode == "spot_show" %>
        <%# スポット詳細画面: ここからプランを作る %>
        <% if user_signed_in? %>
          <button type="button"
                  class="dp-infowindow__btn dp-infowindow__btn--create"
                  data-controller="ui--create-plan-trigger"
                  data-ui--create-plan-trigger-url-value="<%= plans_path(add_spot: spot.id) %>"
                  data-action="click->ui--create-plan-trigger#create">
            ここからプランを作る
          </button>
        <% else %>
          <%= link_to "ここからプランを作る", new_user_session_path(redirect_to: new_plan_path(add_spot: spot.id)), class: "dp-infowindow__btn dp-infowindow__btn--create", data: { turbo_frame: "_top" } %>
        <% end %>
      <% elsif show_button && plan_id.present? %>
        <%# 編集画面: プランに追加/削除 %>
        <% plan_spot = plan_spot_id.present? ? PlanSpot.find_by(id: plan_spot_id) : nil %>
        <%= render "map/infowindow_spot_button", spot: spot, plan_id: plan_id, plan_spot: plan_spot %>
      <% end %>

      <% if edit_mode == "start_point" %>
        <button type="button"
                class="dp-infowindow__edit-btn"
                data-action="click->infowindow--ui#handleEditButton"
                data-edit-action="start_point"
                onclick="this.closest('.gm-style-iw-a')?.querySelector('button.gm-ui-hover-effect')?.click()">
          出発地点を変更
        </button>
      <% elsif edit_mode == "goal_point" %>
        <button type="button"
                class="dp-infowindow__edit-btn"
                data-action="click->infowindow--ui#handleEditButton"
                data-edit-action="goal_point"
                onclick="this.closest('.gm-style-iw-a')?.querySelector('button.gm-ui-hover-effect')?.click()">
          帰宅地点を変更
        </button>
      <% end %>
    </div>
  </div>

  <%# コメントパネル %>
  <div class="dp-infowindow__panel dp-infowindow__panel--comment">
    <div class="dp-infowindow__comments" id="comments-list">
      <% if comments.any? %>
        <%= render partial: "spot_comments/comment",
                   collection: comments,
                   as: :comment,
                   locals: { current_user: current_user } %>
      <% else %>
        <div id="comments-empty" class="dp-infowindow__comments-empty">
          まだコメントはありません
        </div>
      <% end %>
    </div>
    <div class="dp-infowindow__comment-footer">
      <%= render "spot_comments/form", spot: spot %>
    </div>
  </div>
</div>
<% end %>
