<% content_for :body_class, "no-footer" %>
<% content_for :hide_header, true %>

<script>
  window.spotData = {
    lat: <%= @spot.lat %>,
    lng: <%= @spot.lng %>,
    name: "<%= j @spot.name %>",
    address: "<%= j @spot.address.to_s %>",
    placeId: "<%= j @spot.place_id %>"
  };
</script>

<div class="main-content spot-detail"
     data-controller="ui--navibar-resize"
     data-ui--navibar-resize-min-value="300"
     data-ui--navibar-resize-max-percent-value="80"
     data-ui--navibar-resize-default-value="350"
     data-ui--navibar-resize-storage-key-value="drive_peek:navibar_spot_width"
     data-ui--navibar-resize-collapsed-key-value="drive_peek:navibar_spot_collapsed"
     data-ui--navibar-resize-slide-key-value="drive_peek:navibar_spot_slide">
  <%# InfoWindowスケルトンテンプレート（JSから参照） %>
  <%= render "map/infowindow_skeleton" %>

  <!-- 地図 -->
  <div id="map" class="map"
       data-map-mode="spot_show"
       data-spot-id="<%= @spot.id %>"
       data-user-signed-in="<%= user_signed_in? %>"
       data-ui--navibar-resize-target="map"></div>

  <%# 地図上部のヘッダーバー（検索 + ジャンル/盛り上がり + ハンバーガー） %>
  <%= render "shared/map_header_bar" %>

  <!-- デスクトップ用：地図下部中央のアクションボタン -->
  <div class="map-bottom-actions">
    <% if current_user %>
      <button type="button"
              class="map-bottom-actions__btn map-bottom-actions__btn--copy map-bottom-actions__btn--single"
              data-controller="ui--create-plan-trigger"
              data-ui--create-plan-trigger-url-value="<%= plans_path(add_spot: @spot.id) %>"
              data-ui--create-plan-trigger-listen-spot-change-value="true"
              data-action="click->ui--create-plan-trigger#create">
        ここからプランを作る
      </button>
    <% else %>
      <%= link_to new_user_session_path(redirect_to: new_plan_path(add_spot: @spot.id)), class: "map-bottom-actions__btn map-bottom-actions__btn--copy map-bottom-actions__btn--single" do %>
        ここからプランを作る
      <% end %>
    <% end %>
  </div>

  <!-- リサイズハンドル -->
  <div class="navibar-resize-handle"
       data-ui--navibar-resize-target="handle"
       data-action="mousedown->ui--navibar-resize#startResize touchstart->ui--navibar-resize#startResize click->ui--navibar-resize#handleClick">
    <div class="navibar-resize-handle__grip"></div>
  </div>

  <!-- ナビバー（スポット詳細用） -->
  <aside class="navibar navibar--show"
         data-controller="ui--bottom-sheet"
         data-ui--bottom-sheet-min-value="8"
         data-ui--bottom-sheet-mid-value="45"
         data-ui--bottom-sheet-max-value="85"
         data-ui--bottom-sheet-state-value="mid">
    <%# モバイル用ドラッグハンドル %>
    <div class="navibar__handle">
      <div class="navibar__handle-bar"></div>
    </div>

    <div class="navibar__content">
      <div class="navibar__content-scroll">
        <!-- ヘッダー -->
        <div class="navibar__header">
          <%= link_to :back, class: "spot-detail__back-link" do %>
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
          <% end %>
          <h1 class="navibar__title">スポット詳細</h1>
          <div class="spot-detail__header-spacer"></div>
        </div>

        <!-- コンテンツ -->
        <div class="navibar__blocks">
          <div class="spot-detail__main">
            <%= render "shared/spot_card",
                       spot: @spot,
                       favorite_spot: @favorite_spot %>
          </div>

          <%# 関連スポット %>
          <% if @related_spots.any? %>
            <div class="related-section">
              <h2 class="related-section__title">近くの似たスポット</h2>
              <div class="related-section__list">
                <% @related_spots.each do |related_spot| %>
                  <%= render "shared/spot_card",
                             spot: related_spot,
                             favorite_spot: @related_preload[:user_favorite_spots][related_spot.id],
                             spot_stats: @related_preload[:spot_stats][related_spot.id] %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </aside>

  <%# モバイル用InfoWindowボトムシート %>
  <div id="mobile-infowindow"
       class="mobile-infowindow"
       data-controller="infowindow--mobile"
       hidden>
    <div class="mobile-infowindow__sheet" data-infowindow--mobile-target="sheet">
      <div class="mobile-infowindow__handle" data-infowindow--mobile-target="handle">
        <div class="mobile-infowindow__handle-bar"></div>
      </div>
      <div class="mobile-infowindow__content" id="mobile-infowindow-content">
        <%# InfoWindow コンテンツがここに挿入される（閉じるボタン含む） %>
      </div>
    </div>
  </div>
</div>
