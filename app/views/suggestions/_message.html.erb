<%# locals: content:, role:, spots: [], plan_data: nil, plan: nil, intro: "", closing: "", response_type: nil, auto_show: false, area_data: {}, condition_data: {} %>
<%# プラン内スポットのplace_idを一度だけ取得（N+1回避） %>
<% existing_place_ids = plan&.spots&.pluck(:place_id) || [] %>
<% spots = local_assigns.fetch(:spots, []) %>
<% plan_data = local_assigns.fetch(:plan_data, nil) %>
<% intro = local_assigns.fetch(:intro, "") %>
<% closing = local_assigns.fetch(:closing, "") %>
<% response_type = local_assigns.fetch(:response_type, nil) %>
<% auto_show_value = local_assigns.fetch(:auto_show, false) %>
<% area_data = local_assigns.fetch(:area_data, {}) %>
<% condition_data = local_assigns.fetch(:condition_data, {}) %>

<% is_plan_mode = response_type == "plan" && spots.present? %>
<% is_spot_mode = response_type == "spots" && spots.present? %>

<% if is_plan_mode || is_spot_mode %>
  <%# ========== 提案モード共通レイアウト ========== %>
  <%# モードに応じた変数設定 %>
  <% mode = is_plan_mode ? "plan" : "spots" %>
  <% intro_text = intro %>
  <% spot_list = spots %>

  <div class="suggestion__message-wrapper suggestion__message-wrapper--spots">
    <div class="suggestion__divider"></div>

    <%# イントロ（アイコン + テキスト） %>
    <% if intro_text.present? %>
      <div class="suggestion__msg suggestion__msg--assistant">
        <div class="suggestion__icon">
          <i class="bi bi-stars"></i>
        </div>
        <div class="suggestion__content">
          <div class="suggestion__bubble suggestion__bubble--intro">
            <%= simple_format(intro_text, {}, wrapper_tag: nil) %>
          </div>
        </div>
      </div>
    <% end %>

    <%# スポットカード（全幅・中央寄せ） %>
    <% if is_plan_mode %>
      <div class="suggestion__spots-fullwidth"
           data-controller="suggestion-plan-adopt"
           data-suggestion-plan-adopt-plan-id-value="<%= plan&.id %>"
           data-suggestion-plan-adopt-auto-show-value="<%= auto_show_value %>">
        <div class="suggestion__spots-inner" data-suggestion-plan-adopt-target="spots">
          <% spot_list.each_with_index do |spot, index| %>
            <%= render "suggestions/spot_suggestion", spot: spot, plan: plan, number: index + 1, existing_place_ids: existing_place_ids %>
          <% end %>
        </div>
        <div class="suggestion-plan-card__actions">
          <button type="button"
                  class="suggestion-plan-card__adopt-btn"
                  data-action="click->suggestion-plan-adopt#adoptPlan"
                  data-suggestion-plan-adopt-target="adoptBtn">
            <i class="bi bi-check-circle"></i> このプランを採用
          </button>
        </div>
      </div>
    <% else %>
      <div class="suggestion__spots-fullwidth"
           data-suggestion-target="spotSuggestions"
           data-controller="suggestion-spots-batch"
           data-suggestion-spots-batch-auto-show-value="<%= auto_show_value %>">
        <% spot_list.each_with_index do |spot, index| %>
          <%= render "suggestions/spot_suggestion", spot: spot, plan: plan, number: index + 1, existing_place_ids: existing_place_ids %>
        <% end %>
      </div>
    <% end %>

    <%# 締め + アクションボタン（アイコン + テキスト） %>
    <div class="suggestion__msg suggestion__msg--assistant">
      <div class="suggestion__icon">
        <i class="bi bi-stars"></i>
      </div>
      <div class="suggestion__content">
        <% if closing.present? %>
          <div class="suggestion__bubble suggestion__bubble--closing">
            <%= closing %>
          </div>
        <% end %>
        <%= render "suggestions/action_buttons", mode: mode, area_data: area_data, condition_data: condition_data, plan: plan %>
        <div class="suggestion__meta">
          <span class="suggestion__time"><%= Time.current.strftime("%H:%M") %></span>
        </div>
      </div>
    </div>
  </div>

<% else %>
  <%# ========== 通常レイアウト（2カラム） ========== %>
  <div class="suggestion__message-wrapper">
    <div class="suggestion__divider"></div>
    <div class="suggestion__msg suggestion__msg--<%= role %>">
      <% if role == "assistant" %>
        <div class="suggestion__icon">
          <i class="bi bi-stars"></i>
        </div>
      <% end %>
      <div class="suggestion__content">

        <% if response_type == "answer" %>
          <%# 詳細説明モード %>
          <% if content.present? %>
            <div class="suggestion__bubble">
              <%= Kramdown::Document.new(content.to_s, hard_wrap: true).to_html.html_safe %>
            </div>
          <% end %>
          <% if spots.present? %>
            <div class="suggestion__related-spots">
              <small class="suggestion__related-label">関連スポット</small>
              <% spots.each_with_index do |spot, index| %>
                <%= render "suggestions/spot_suggestion", spot: spot, plan: plan, number: index + 1, compact: true, existing_place_ids: existing_place_ids %>
              <% end %>
            </div>
          <% end %>
          <% if closing.present? %>
            <div class="suggestion__bubble suggestion__bubble--closing">
              <%= closing %>
            </div>
          <% end %>

        <% elsif response_type == "mode_select" %>
          <%# モード選択UI %>
          <% if content.present? %>
            <div class="suggestion__bubble">
              <%= content %>
            </div>
          <% end %>
          <%= render "suggestions/mode_select" %>

        <% else %>
          <%# 会話モード %>
          <% if content.present? %>
            <div class="suggestion__bubble">
              <% if role == "assistant" %>
                <%= Kramdown::Document.new(content.to_s, hard_wrap: true).to_html.html_safe %>
              <% else %>
                <%= simple_format(content.to_s, {}, wrapper_tag: nil) %>
              <% end %>
            </div>
          <% end %>
        <% end %>

        <div class="suggestion__meta">
          <span class="suggestion__time"><%= Time.current.strftime("%H:%M") %></span>
          <% if role == "assistant" %>
            <button type="button" class="suggestion__action-btn" data-action="click->suggestion#copyMessage" title="コピー">
              <i class="bi bi-clipboard"></i>
            </button>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>
