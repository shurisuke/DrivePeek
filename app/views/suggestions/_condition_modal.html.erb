<%# 提案条件設定モーダル（プランモード） %>
<% genre_by_category = Genre.grouped_by_category %>

<div class="suggestion-condition-modal"
     hidden
     data-controller="suggestion-tab--condition-modal"
     data-suggestion-tab--condition-modal-plan-id-value="<%= plan.id %>"
     data-action="keydown.esc->suggestion-tab--condition-modal#cancel">
  <div class="suggestion-condition-modal__overlay"></div>
  <div class="suggestion-condition-modal__dialog">

    <%# ========== メインビュー ========== %>
    <div data-suggestion-tab--condition-modal-target="mainView">
      <%# ヘッダー %>
      <div class="suggestion-condition-modal__header">
        <h3 class="suggestion-condition-modal__title" data-suggestion-tab--condition-modal-target="title">条件を設定</h3>
        <button type="button"
                class="suggestion-condition-modal__close-btn"
                data-action="click->suggestion-tab--condition-modal#cancel">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <%# エリア情報 %>
      <div class="suggestion-condition-modal__area-info">
        <i class="bi bi-geo-alt"></i>
        <span data-suggestion-tab--condition-modal-target="areaInfo">選択エリア</span>
      </div>

      <%# プラン条件設定 %>
      <div>
        <%# スポット数選択 %>
        <div class="suggestion-condition-modal__section">
          <label class="suggestion-condition-modal__label">立ち寄りスポット数</label>
          <select class="suggestion-condition-modal__select"
                  data-suggestion-tab--condition-modal-target="spotCount"
                  data-action="change->suggestion-tab--condition-modal#updateSlots">
            <% (2..5).each do |n| %>
              <option value="<%= n %>" <%= 'selected' if n == 3 %>><%= n %>箇所</option>
            <% end %>
          </select>
        </div>

        <%# スロット一覧 %>
        <div class="suggestion-condition-modal__slots">
          <% 5.times do |i| %>
            <div class="suggestion-condition-modal__slot"
                 data-suggestion-tab--condition-modal-target="slot"
                 data-slot-index="<%= i %>"
                 <%= 'hidden' if i >= 3 %>>
              <span class="suggestion-condition-modal__slot-label">スポット <%= i + 1 %></span>
              <button type="button"
                      class="suggestion-condition-modal__genre-btn"
                      data-action="click->suggestion-tab--condition-modal#openGenreSelect"
                      data-suggestion-tab--condition-modal-target="slotBtn">
                <span>おまかせ</span>
                <i class="bi bi-plus"></i>
              </button>
              <input type="hidden" name="slots[][genre_id]" value="" data-suggestion-tab--condition-modal-target="slotInput">
            </div>
          <% end %>
        </div>
      </div>

      <%# 送信ボタン %>
      <div class="suggestion-condition-modal__actions">
        <button type="button"
                class="suggestion-condition-modal__btn suggestion-condition-modal__btn--cancel"
                data-action="click->suggestion-tab--condition-modal#cancel">
          キャンセル
        </button>
        <button type="button"
                class="suggestion-condition-modal__btn suggestion-condition-modal__btn--submit"
                data-suggestion-tab--condition-modal-target="submitBtn"
                data-action="click->suggestion-tab--condition-modal#submit">
          <i class="bi bi-stars"></i>
          決定
        </button>
      </div>

      <%# ローディング表示 %>
      <div class="suggestion-condition-modal__loading" hidden data-suggestion-tab--condition-modal-target="loading">
        <div class="suggestion-loading">
          <div class="suggestion-loading__orb">
            <div class="suggestion-loading__orb-inner"></div>
            <div class="suggestion-loading__sparkles">
              <i class="bi bi-stars"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-stars"></i>
              <i class="bi bi-star-fill"></i>
            </div>
          </div>
          <div class="suggestion-loading__text">
            <span class="suggestion-loading__label">AIが考え中</span>
            <span class="suggestion-loading__dots">
              <span>.</span><span>.</span><span>.</span>
            </span>
          </div>
          <div class="suggestion-loading__bar"></div>
        </div>
      </div>
    </div>

    <%# ========== ジャンル選択ビュー ========== %>
    <div data-suggestion-tab--condition-modal-target="genreView" hidden>
      <div class="suggestion-condition-modal__header">
        <h3 class="suggestion-condition-modal__title">ジャンルを選択</h3>
        <button type="button"
                class="suggestion-condition-modal__close-btn"
                data-action="click->suggestion-tab--condition-modal#closeGenreSelect">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="selection-list suggestion-condition-modal__genre-list">
        <%# おまかせ %>
        <button type="button"
                class="selection-list__item selection-list__item--omakase"
                data-action="click->suggestion-tab--condition-modal#selectGenre"
                data-genre-id=""
                data-genre-name="おまかせ">
          <span>おまかせ</span>
        </button>

        <% genre_by_category.each do |category, groups| %>
          <div class="selection-list__region">
            <div class="selection-list__region-label"><%= category %></div>
            <% groups.each do |group| %>
              <% genre = group[:genre] %>
              <% children = group[:children] %>
              <% if children.present? %>
                <%# 子ジャンルあり: 展開式 %>
                <div class="selection-list__group">
                  <div class="selection-list__parent">
                    <button type="button"
                            class="selection-list__parent-btn"
                            data-action="click->suggestion-tab--condition-modal#selectGenre"
                            data-genre-id="<%= genre.id %>"
                            data-genre-name="<%= genre.name %>">
                      <span><%= genre.name %></span>
                    </button>
                    <i class="bi bi-chevron-down selection-list__toggle"
                       data-action="click->suggestion-tab--condition-modal#toggleGroup"></i>
                  </div>
                  <div class="selection-list__children">
                    <% children.each do |child| %>
                      <button type="button"
                              class="selection-list__item"
                              data-action="click->suggestion-tab--condition-modal#selectGenre"
                              data-genre-id="<%= child.id %>"
                              data-genre-name="<%= child.name %>">
                        <span><%= child.name %></span>
                      </button>
                    <% end %>
                  </div>
                </div>
              <% else %>
                <%# 子ジャンルなし: 単独ボタン %>
                <button type="button"
                        class="selection-list__item"
                        data-action="click->suggestion-tab--condition-modal#selectGenre"
                        data-genre-id="<%= genre.id %>"
                        data-genre-name="<%= genre.name %>">
                  <span><%= genre.name %></span>
                </button>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

  </div>
</div>
