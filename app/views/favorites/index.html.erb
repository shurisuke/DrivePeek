<%# お気に入り一覧（favorites#index） %>

<div class="list-page list-page--two-column">
  <h1 class="list-page__title">お気に入り</h1>

  <div class="list-page__content">
  <%# 左サイドバー: 検索フォーム %>
  <div class="list-page__sidebar">
    <%= render "shared/search_form",
               form_url: favorites_path,
               search_type: @search_type,
               selected_cities: @selected_cities,
               cities_by_prefecture: @cities_by_prefecture,
               genres_by_category: @genres_by_category,
               selected_genre_ids: @selected_genre_ids,
               search_query: @search_query %>

    <%= render "shared/results_bar",
               count: @search_type == "spot" ? @spots_count : @plans_count,
               count_label: @search_type == "spot" ? "スポット" : "プラン",
               sort: @sort,
               sort_options: [["newest", "新しい順"], ["oldest", "古い順"]] %>
  </div>

  <%# 右メイン: カード一覧 + ページネーション %>
  <div class="list-page__main">
  <% if @search_type == "spot" %>
      <%# スポット一覧 %>
      <% if @spots.present? %>
        <div class="list-page__cards">
          <% @spots.each do |spot| %>
            <%= render "plans/spot_card", spot: spot, favorite_spot: @user_favorite_spots[spot.id], spot_stats: @spot_stats[spot.id] %>
          <% end %>
        </div>

        <% if @spots.total_pages > 1 %>
          <div class="list-page__pagination">
            <%= paginate @spots %>
          </div>
        <% end %>
      <% else %>
        <div class="list-page__empty">
          <% if @search_query.present? || @selected_cities.present? || @selected_genre_ids.present? %>
            <p>条件に一致するお気に入りスポットが見つかりませんでした</p>
          <% else %>
            <p>お気に入りスポットがありません</p>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <%# プラン一覧 %>
      <% if @plans.present? %>
        <% favorite_plans_map = FavoritePlan.index_by_plan_id(user: current_user, plan_ids: @plans.map(&:id)) %>
        <div class="list-page__cards">
          <% @plans.each do |plan| %>
            <%
              spots_data = plan.plan_spots.sort_by(&:position).map do |ps|
                spot = ps.spot
                {
                  name: spot.name,
                  address: spot.address,
                  prefecture: spot.prefecture,
                  city: spot.city
                }
              end
              genre_names = plan.plan_spots.flat_map { |ps| ps.spot.genres.map(&:name) }.uniq
            %>
            <%= render "plans/plan_card",
                       plan_title: plan_title(plan),
                       spots: spots_data,
                       genres: genre_names,
                       total_duration: format_move_time(plan.spots_only_move_time),
                       total_distance: format_distance(plan.spots_only_distance),
                       plan: plan,
                       favorite_plan: favorite_plans_map[plan.id] %>
          <% end %>
        </div>

        <% if @plans.total_pages > 1 %>
          <div class="list-page__pagination">
            <%= paginate @plans %>
          </div>
        <% end %>
      <% else %>
        <div class="list-page__empty">
          <% if @search_query.present? || @selected_cities.present? || @selected_genre_ids.present? %>
            <p>条件に一致するお気に入りプランが見つかりませんでした</p>
          <% else %>
            <p>お気に入りプランがありません</p>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
  </div>
</div>
