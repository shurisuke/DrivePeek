# Issue #31: 非同期お気に入り（Spot）機能（like_spots）

## 目的
プラン作成画面のスポットブロック内（トグル内）にある既存のお気に入り（ハート）ボタンをタップすると、
ページ遷移なしで「お気に入り登録/解除」ができ、ハートの見た目（塗り/色）が即時に切り替わるようにする。

## 対象UI（必須）
- 対象View：`app/views/plans/form_components/_spot_block.html.erb`
- 対象ボタン：既存の
  - `button.btn.btn-outline-secondary.btn-sm.w-100.btn-fav-icon`
  - 内部のアイコン：`<i class="bi bi-heart">`（状態に応じて `bi-heart-fill` 等に切替）

※ このボタンをベースに実装する（新しい別ボタンに置き換えない）。

---

## 要件（必須）
- DBは **like_spots テーブル** を使用する（current_user と spot を結びつける）
- 非同期（ページ全体リロードなし）で登録/解除できること
- 1ユーザー×1スポットは1レコードのみ（重複を作らない）
- 未ログインなら実行できない（認証は既存の仕組みに従う）
- 失敗時（例：通信/422/500）でもUIが破綻しない（ボタンが壊れない / 状態が矛盾しない）

## 非要件（今回はやらない）
- 一覧画面や詳細画面への波及（必要なら別Issue）
- お気に入り数ランキング等

---

## 実装方針（推奨）
- Turbo（Frame or Stream）で **「ボタン部分だけ」** を更新する
  - 例：お気に入りボタン周辺を `turbo_frame_tag` で囲み、create/destroy のレスポンスで差し替え
- `LikeSpotsController` を作り、`create` / `destroy` の2アクションで完結させる（REST）
- ルーティングは **spot_id を確実に受け取れる形** にする（nested/param方式どちらでも可）
- 既存構造に合わせて実装する（partial/ヘルパー/モデル責務の置き場所は既存流儀に寄せる）

### 新規ファイルについて
- 「新規ファイルは悪」ではない。**責務分離・可読性が上がるなら作成してよい**
- ただし、作成する場合は必ず以下を明記する：
  1) なぜ既存拡張だけでは責務が破綻するのか  
  2) 代替案（既存ファイル内で済ませる案）  
  3) 採用理由（保守性/責務/変更範囲）

---

## 受け入れ基準（Acceptance Criteria）
1) ログイン中、ハートを押すと「お気に入り登録」され、ハートが **ON状態（塗り/色つき）** になる
2) もう一度押すと「お気に入り解除」され、ハートが **OFF状態（アウトライン/薄色）** になる
3) 上記は **画面全体のリロードなし** で行われる
4) 連打しても like_spots が重複作成されない
5) 失敗時もボタンやトグル内UIが崩れない（最低限、操作継続できる）

---

## 実装ステップ（Claudeはこの順で進める）
### 1) 既存コード調査（捏造禁止）
- 既にお気に入り関連のUI/partial/ルート/コントローラ/モデルが存在するか確認する
- `like_spots` テーブル/モデル/ユニーク制約の有無を確認する
- `_spot_block.html.erb` 内の `.btn-fav-icon` がどこまで共通化されているか確認する

### 2) Viewの改修（既存ボタンを活かす）
- `.btn-fav-icon` をTurbo更新可能な単位にする（Frame/Stream）
- spot_id を確実に送れるようにする（data属性 or パス生成）
- 既存のイベント（ドラッグ/トグル/stopPropagation）と衝突する場合は、既存方針に合わせて抑制する

### 3) コントローラ
- `create`: current_user が spot をお気に入り登録
- `destroy`: current_user が spot をお気に入り解除
- 返却：ボタン部分のみ更新（Turboで統一）

### 4) モデル/制約
- 重複防止（DBユニーク制約 or バリデーション or find_or_create_by 等）
- 「お気に入り済み判定」を自然に書ける形に整える（関連/ヘルパー等）

---

## UI仕様（最低限）
- OFF: `bi-heart`
- ON: `bi-heart-fill` ＋色強め
- 既存ボタンのサイズ/余白/配置は維持（`.btn-fav-icon` の見た目基準）

---

## テスト（必須）
### 手動テスト（最低3ケース）
1) ログイン中：OFF → ON（登録）になり、画面リロードしない
2) ログイン中：ON → OFF（解除）になり、画面リロードしない
3) 連打/二重送信でも重複レコードが増えない（DB確認 or ログで確認）

### 自動テスト（可能なら）
- Model: LikeSpot の重複防止（ユニーク/バリデーション）
- Controller: create/destroy の基本動作