# CLAUDE.md
Claude Code (claude.ai/code) 用のリポジトリ運用ルール

## 0. 作業開始プロトコル（必須）
依頼を受けたら必ず次の順で進めること。

1) この `CLAUDE.md` を読み、遵守する
2) 依頼で指定された **単一の** `doc/tasks/*.md`（または明示された一覧）を読む
   - フォルダ内を勝手に探索しない
   - `doc/tasks/` が無い / 指定ファイルが無い場合は捏造せず「不明」
3) 内部で順次思考してよいが **思考過程は出力しない**（結論・手順のみ出力）

理解確認（必ず明示）：
- これは **再利用・統合** のプロジェクト
- 新規ファイル作成は **強い正当化が必要**
- 提案は **既存コード参照が必須**
- 破れば応答は **無効**

## 1. 進め方（必須）
応答は必ずこの構成で出す：

### 冒頭（必須）
> コンプライアンス確認済み：作成よりも再利用を優先します

### 本文（必須）
1) **既存コード分析**：関連ファイルパス列挙 + 理由（各1行）
   - 「実在確認できない場合は“不明”とし、確認コマンドを依頼する」
2) **実装計画**：変更点最小・再利用最優先
   - 新規ファイルが必要なら「既存拡張不可の理由」「代替案」も書く
3) **技術的詳細**：ファイルごとに変更内容（必要なら全文提示）
4) **検証（必須）**：手動テスト 3ケース以上 +（可能なら）自動テストコマンド提示（例: `bin/rails test ...`）

### 末尾（必須）
- コンプライアンス確認で終了すること
- 最後は必ず次の1文で終える：
  > コンプライアンス確認：既存コード参照・再利用優先・捏造なしで回答しました

## 2. 不変ルール（必ず守る）
### Rails
- 規約優先・シンプルに
- コントローラは薄く、実ロジックはモデル（or小さな調整役）へ
- 巨大Service禁止 / `Service#call` 禁止（必要なら意図が伝わるメソッド名）
- DHH的に考える：まず「Railsの規約で素直に書けるか」を優先し、過剰な抽象化・設定・汎用化はしない。

### Map / Marker
- マーカー生成・クリアは必ず `app/javascript/map/state.js` の setter/clearer 経由
- state 外に参照を保持しない

### Turbo / Stimulus
- Map初期化は `turbo:load`
- InfoWindow はイベントデリゲーション等で確実に拾う